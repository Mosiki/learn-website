<!DOCTYPE html>
<!-- saved from url=(0046)https://kaiiiz.github.io/hexo-theme-book-demo/ -->
<html xmlns="http://www.w3.org/1999/xhtml">

<head>

    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
        <link rel="icon" href="../../static/favicon.png">
        <title>32 实战演练：玩转Kubernetes（3）.md</title>
        <!-- Spectre.css framework -->
        <link rel="stylesheet" href="../../static/index.css">
        <link rel="stylesheet"
              href="../../static/highlight.min.css">
        <script src="../../static/highlight.min.js"></script>
        <!-- theme css & js -->
        <meta name="generator" content="Hexo 4.2.0">
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5295275829820252"
                crossorigin="anonymous"></script>
        <script async defer data-website-id="83e5d5db-9d06-40e3-b780-cbae722fdf8c" src="https://analyze.lianglianglee.com/umami.js"></script>
    </head>

<body>

    <div class="book-container">
        <div class="book-sidebar">
            <div class="book-brand">
                <a href="../../index.html">
                    <img src="../../static/favicon.png">
                    <span>技术文章摘抄</span>
                </a>
            </div>
            <div class="book-menu uncollapsible">
                <ul class="uncollapsible">
                    <li><a href="../../index.html" class="current-tab">首页</a></li>
                </ul>

                <ul class="uncollapsible">
                    <li><a href="../index.html">上一级</a></li>
                </ul>

                <ul class="uncollapsible">
                    <li>

                        
                        <a href="00%20%E5%BC%80%E7%AF%87%E8%AF%8D%20%E8%BF%8E%E9%9A%BE%E8%80%8C%E4%B8%8A%EF%BC%8C%E5%81%9A%E4%BA%91%E5%8E%9F%E7%94%9F%E6%97%B6%E4%BB%A3%E7%9A%84%E5%BC%84%E6%BD%AE%E5%84%BF.md.html">00 开篇词 迎难而上，做云原生时代的弄潮儿.md</a>

                    </li>
                    <li>

                        
                        <a href="00%20%E8%AF%BE%E5%89%8D%E5%87%86%E5%A4%87%20%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5%E6%89%8D%E6%98%AF%E6%9C%80%E5%A5%BD%E7%9A%84%E5%AD%A6%E4%B9%A0%E6%96%B9%E5%BC%8F.md.html">00 课前准备 动手实践才是最好的学习方式.md</a>

                    </li>
                    <li>

                        
                        <a href="01%20%E5%88%9D%E8%AF%86%E5%AE%B9%E5%99%A8%EF%BC%9A%E4%B8%87%E4%BA%8B%E5%BC%80%E5%A4%B4%E9%9A%BE.md.html">01 初识容器：万事开头难.md</a>

                    </li>
                    <li>

                        
                        <a href="02%20%E8%A2%AB%E9%9A%94%E7%A6%BB%E7%9A%84%E8%BF%9B%E7%A8%8B%EF%BC%9A%E4%B8%80%E8%B5%B7%E6%9D%A5%E7%9C%8B%E7%9C%8B%E5%AE%B9%E5%99%A8%E7%9A%84%E6%9C%AC%E8%B4%A8.md.html">02 被隔离的进程：一起来看看容器的本质.md</a>

                    </li>
                    <li>

                        
                        <a href="03%20%E5%AE%B9%E5%99%A8%E5%8C%96%E7%9A%84%E5%BA%94%E7%94%A8%EF%BC%9A%E4%BC%9A%E4%BA%86%E8%BF%99%E4%BA%9B%E4%BD%A0%E5%B0%B1%E6%98%AFDocker%E9%AB%98%E6%89%8B.md.html">03 容器化的应用：会了这些你就是Docker高手.md</a>

                    </li>
                    <li>

                        
                        <a href="04%20%E5%88%9B%E5%BB%BA%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%EF%BC%9A%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%E6%AD%A3%E7%A1%AE%E3%80%81%E9%AB%98%E6%95%88%E7%9A%84Dockerfile.md.html">04 创建容器镜像：如何编写正确、高效的Dockerfile.md</a>

                    </li>
                    <li>

                        
                        <a href="05%20%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%EF%BC%9A%E8%AF%A5%E6%80%8E%E6%A0%B7%E7%94%A8%E5%A5%BDDocker%20Hub%E8%BF%99%E4%B8%AA%E5%AE%9D%E8%97%8F.md.html">05 镜像仓库：该怎样用好Docker Hub这个宝藏.md</a>

                    </li>
                    <li>

                        
                        <a href="06%20%E6%89%93%E7%A0%B4%E6%AC%A1%E5%85%83%E5%A3%81%EF%BC%9A%E5%AE%B9%E5%99%A8%E8%AF%A5%E5%A6%82%E4%BD%95%E4%B8%8E%E5%A4%96%E7%95%8C%E4%BA%92%E8%81%94%E4%BA%92%E9%80%9A.md.html">06 打破次元壁：容器该如何与外界互联互通.md</a>

                    </li>
                    <li>

                        
                        <a href="07%20%E5%AE%9E%E6%88%98%E6%BC%94%E7%BB%83%EF%BC%9A%E7%8E%A9%E8%BD%ACDocker.md.html">07 实战演练：玩转Docker.md</a>

                    </li>
                    <li>

                        
                        <a href="08%20%E8%A7%86%E9%A2%91%EF%BC%9A%E5%85%A5%E9%97%A8%E7%AF%87%E5%AE%9E%E6%93%8D%E6%80%BB%E7%BB%93.md.html">08 视频：入门篇实操总结.md</a>

                    </li>
                    <li>

                        
                        <a href="09%20%E8%B5%B0%E8%BF%91%E4%BA%91%E5%8E%9F%E7%94%9F%EF%BC%9A%E5%A6%82%E4%BD%95%E5%9C%A8%E6%9C%AC%E6%9C%BA%E6%90%AD%E5%BB%BA%E5%B0%8F%E5%B7%A7%E5%AE%8C%E5%A4%87%E7%9A%84Kubernetes%E7%8E%AF%E5%A2%83.md.html">09 走近云原生：如何在本机搭建小巧完备的Kubernetes环境.md</a>

                    </li>
                    <li>

                        
                        <a href="10%20%E8%87%AA%E5%8A%A8%E5%8C%96%E7%9A%84%E8%BF%90%E7%BB%B4%E7%AE%A1%E7%90%86%EF%BC%9A%E6%8E%A2%E7%A9%B6Kubernetes%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6%E7%9A%84%E5%A5%A5%E7%A7%98.md.html">10 自动化的运维管理：探究Kubernetes工作机制的奥秘.md</a>

                    </li>
                    <li>

                        
                        <a href="11%20YAML%EF%BC%9AKubernetes%E4%B8%96%E7%95%8C%E9%87%8C%E7%9A%84%E9%80%9A%E7%94%A8%E8%AF%AD.md.html">11 YAML：Kubernetes世界里的通用语.md</a>

                    </li>
                    <li>

                        
                        <a href="12%20Pod%EF%BC%9A%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E8%BF%99%E4%B8%AAKubernetes%E9%87%8C%E6%9C%80%E6%A0%B8%E5%BF%83%E7%9A%84%E6%A6%82%E5%BF%B5%EF%BC%9F.md.html">12 Pod：如何理解这个Kubernetes里最核心的概念？.md</a>

                    </li>
                    <li>

                        
                        <a href="13%20Job_CronJob%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E7%9B%B4%E6%8E%A5%E7%94%A8Pod%E6%9D%A5%E5%A4%84%E7%90%86%E4%B8%9A%E5%8A%A1%EF%BC%9F.md.html">13 Job_CronJob：为什么不直接用Pod来处理业务？.md</a>

                    </li>
                    <li>

                        
                        <a href="14%20ConfigMap_Secret%EF%BC%9A%E6%80%8E%E6%A0%B7%E9%85%8D%E7%BD%AE%E3%80%81%E5%AE%9A%E5%88%B6%E6%88%91%E7%9A%84%E5%BA%94%E7%94%A8.md.html">14 ConfigMap_Secret：怎样配置、定制我的应用.md</a>

                    </li>
                    <li>

                        
                        <a href="15%20%E5%AE%9E%E6%88%98%E6%BC%94%E7%BB%83%EF%BC%9A%E7%8E%A9%E8%BD%ACKubernetes%EF%BC%881%EF%BC%89.md.html">15 实战演练：玩转Kubernetes（1）.md</a>

                    </li>
                    <li>

                        
                        <a href="16%20%E8%A7%86%E9%A2%91%EF%BC%9A%E5%88%9D%E7%BA%A7%E7%AF%87%E5%AE%9E%E6%93%8D%E6%80%BB%E7%BB%93.md.html">16 视频：初级篇实操总结.md</a>

                    </li>
                    <li>

                        
                        <a href="17%20%E6%9B%B4%E7%9C%9F%E5%AE%9E%E7%9A%84%E4%BA%91%E5%8E%9F%E7%94%9F%EF%BC%9A%E5%AE%9E%E9%99%85%E6%90%AD%E5%BB%BA%E5%A4%9A%E8%8A%82%E7%82%B9%E7%9A%84Kubernetes%E9%9B%86%E7%BE%A4.md.html">17 更真实的云原生：实际搭建多节点的Kubernetes集群.md</a>

                    </li>
                    <li>

                        
                        <a href="18%20Deployment%EF%BC%9A%E8%AE%A9%E5%BA%94%E7%94%A8%E6%B0%B8%E4%B8%8D%E5%AE%95%E6%9C%BA.md.html">18 Deployment：让应用永不宕机.md</a>

                    </li>
                    <li>

                        
                        <a href="19%20Daemonset%EF%BC%9A%E5%BF%A0%E5%AE%9E%E5%8F%AF%E9%9D%A0%E7%9A%84%E7%9C%8B%E9%97%A8%E7%8B%97.md.html">19 Daemonset：忠实可靠的看门狗.md</a>

                    </li>
                    <li>

                        
                        <a href="20%20Service%EF%BC%9A%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E5%BA%94%E5%AF%B9%E4%B9%8B%E9%81%93.md.html">20 Service：微服务架构的应对之道.md</a>

                    </li>
                    <li>

                        
                        <a href="21%20Ingress%EF%BC%9A%E9%9B%86%E7%BE%A4%E8%BF%9B%E5%87%BA%E6%B5%81%E9%87%8F%E7%9A%84%E6%80%BB%E7%AE%A1.md.html">21 Ingress：集群进出流量的总管.md</a>

                    </li>
                    <li>

                        
                        <a href="22%20%E5%AE%9E%E6%88%98%E6%BC%94%E7%BB%83%EF%BC%9A%E7%8E%A9%E8%BD%ACKubernetes%EF%BC%882%EF%BC%89.md.html">22 实战演练：玩转Kubernetes（2）.md</a>

                    </li>
                    <li>

                        
                        <a href="23%20%E8%A7%86%E9%A2%91%EF%BC%9A%E4%B8%AD%E7%BA%A7%E7%AF%87%E5%AE%9E%E6%93%8D%E6%80%BB%E7%BB%93.md.html">23 视频：中级篇实操总结.md</a>

                    </li>
                    <li>

                        
                        <a href="24%20PersistentVolume%EF%BC%9A%E6%80%8E%E4%B9%88%E8%A7%A3%E5%86%B3%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96%E7%9A%84%E9%9A%BE%E9%A2%98%EF%BC%9F.md.html">24 PersistentVolume：怎么解决数据持久化的难题？.md</a>

                    </li>
                    <li>

                        
                        <a href="https://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Kubernetes%E5%85%A5%E9%97%A8%E5%AE%9E%E6%88%98%E8%AF%BE/25%20PersistentVolume%20+%20NFS%EF%BC%9A%E6%80%8E%E4%B9%88%E4%BD%BF%E7%94%A8%E7%BD%91%E7%BB%9C%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%EF%BC%9F.md">25 PersistentVolume + NFS：怎么使用网络共享存储？.md</a>

                    </li>
                    <li>

                        
                        <a href="26%20StatefulSet%EF%BC%9A%E6%80%8E%E4%B9%88%E7%AE%A1%E7%90%86%E6%9C%89%E7%8A%B6%E6%80%81%E7%9A%84%E5%BA%94%E7%94%A8%EF%BC%9F.md.html">26 StatefulSet：怎么管理有状态的应用？.md</a>

                    </li>
                    <li>

                        
                        <a href="27%20%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0%EF%BC%9A%E5%A6%82%E4%BD%95%E5%81%9A%E5%88%B0%E5%B9%B3%E6%BB%91%E7%9A%84%E5%BA%94%E7%94%A8%E5%8D%87%E7%BA%A7%E9%99%8D%E7%BA%A7%EF%BC%9F.md.html">27 滚动更新：如何做到平滑的应用升级降级？.md</a>

                    </li>
                    <li>

                        
                        <a href="28%20%E5%BA%94%E7%94%A8%E4%BF%9D%E9%9A%9C%EF%BC%9A%E5%A6%82%E4%BD%95%E8%AE%A9Pod%E8%BF%90%E8%A1%8C%E5%BE%97%E6%9B%B4%E5%81%A5%E5%BA%B7%EF%BC%9F.md.html">28 应用保障：如何让Pod运行得更健康？.md</a>

                    </li>
                    <li>

                        
                        <a href="29%20%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%EF%BC%9A%E5%A6%82%E4%BD%95%E7%94%A8%E5%90%8D%E5%AD%97%E7%A9%BA%E9%97%B4%E5%88%86%E9%9A%94%E7%B3%BB%E7%BB%9F%E8%B5%84%E6%BA%90%EF%BC%9F.md.html">29 集群管理：如何用名字空间分隔系统资源？.md</a>

                    </li>
                    <li>

                        
                        <a href="30%20%E7%B3%BB%E7%BB%9F%E7%9B%91%E6%8E%A7%EF%BC%9A%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8Metrics%20Server%E5%92%8CPrometheus%EF%BC%9F.md.html">30 系统监控：如何使用Metrics Server和Prometheus？.md</a>

                    </li>
                    <li>

                        
                        <a href="31%20%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%EF%BC%9ACNI%E6%98%AF%E6%80%8E%E4%B9%88%E5%9B%9E%E4%BA%8B%EF%BC%9F%E5%8F%88%E6%98%AF%E6%80%8E%E4%B9%88%E5%B7%A5%E4%BD%9C%E7%9A%84%EF%BC%9F.md.html">31 网络通信：CNI是怎么回事？又是怎么工作的？.md</a>

                    </li>
                    <li>

                        <a class="current-tab" href="32%20%E5%AE%9E%E6%88%98%E6%BC%94%E7%BB%83%EF%BC%9A%E7%8E%A9%E8%BD%ACKubernetes%EF%BC%883%EF%BC%89.md.html">32 实战演练：玩转Kubernetes（3）.md</a>
                        

                    </li>
                    <li>

                        
                        <a href="33%20%E8%A7%86%E9%A2%91%EF%BC%9A%E9%AB%98%E7%BA%A7%E7%AF%87%E5%AE%9E%E6%93%8D%E6%80%BB%E7%BB%93.md.html">33 视频：高级篇实操总结.md</a>

                    </li>
                    <li>

                        
                        <a href="%E5%8A%A0%E9%A4%90%20docker-compose%EF%BC%9A%E5%8D%95%E6%9C%BA%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7.md.html">加餐 docker-compose：单机环境下的容器编排工具.md</a>

                    </li>
                    <li>

                        
                        <a href="%E5%8A%A0%E9%A4%90%20%E8%B0%88%E8%B0%88Kong%20Ingress%20Controller.md.html">加餐 谈谈Kong Ingress Controller.md</a>

                    </li>
                    <li>

                        
                        <a href="%E7%BB%93%E6%9D%9F%E8%AF%AD%20%E6%98%AF%E7%BB%88%E7%82%B9%EF%BC%8C%E6%9B%B4%E6%98%AF%E8%B5%B7%E7%82%B9.md.html">结束语 是终点，更是起点.md</a>

                    </li>
                </ul>

            </div>
        </div>

        <div class="sidebar-toggle" onclick="sidebar_toggle()" onmouseover="add_inner()" onmouseleave="remove_inner()">
            <div class="sidebar-toggle-inner"></div>
        </div>

        <script>
            function add_inner() {
                let inner = document.querySelector('.sidebar-toggle-inner')
                inner.classList.add('show')
            }

            function remove_inner() {
                let inner = document.querySelector('.sidebar-toggle-inner')
                inner.classList.remove('show')
            }

            function sidebar_toggle() {
                let sidebar_toggle = document.querySelector('.sidebar-toggle')
                let sidebar = document.querySelector('.book-sidebar')
                let content = document.querySelector('.off-canvas-content')
                if (sidebar_toggle.classList.contains('extend')) { // show
                    sidebar_toggle.classList.remove('extend')
                    sidebar.classList.remove('hide')
                    content.classList.remove('extend')
                } else { // hide
                    sidebar_toggle.classList.add('extend')
                    sidebar.classList.add('hide')
                    content.classList.add('extend')
                }
            }


            function open_sidebar() {
                let sidebar = document.querySelector('.book-sidebar')
                let overlay = document.querySelector('.off-canvas-overlay')
                sidebar.classList.add('show')
                overlay.classList.add('show')
            }
            function hide_canvas() {
                let sidebar = document.querySelector('.book-sidebar')
                let overlay = document.querySelector('.off-canvas-overlay')
                sidebar.classList.remove('show')
                overlay.classList.remove('show')
            }

        </script>

        <div class="off-canvas-content">
            <div class="columns">
                <div class="column col-12 col-lg-12">
                    <div class="book-navbar">
                        <!-- For Responsive Layout -->
                        <header class="navbar">
                            <section class="navbar-section">
                                <a onclick="open_sidebar()">
                                    <i class="icon icon-menu"></i>
                                </a>
                            </section>
                        </header>
                    </div>
                    <div class="book-content" style="max-width: 960px; margin: 0 auto;
    overflow-x: auto;
    overflow-y: hidden;">
                        <div class="book-post">
                            <p id="tip" align="center"></p>
                            <div><h1>32 实战演练：玩转Kubernetes（3）</h1>
<p>你好，我是Chrono。</p>
<p>到今天，我们的“高级篇”课程也要结束了。比起前面的“初级篇”“中级篇”来说，这里的知识点比较多，难度也要高一些。如果你能够一篇不漏地学习下来，相信一定对Kubernetes有更深层次的认识和理解。</p>
<p>今天的这节课还是来对前面的知识做回顾与总结，提炼出文章里的学习要点和重点，你也可以顺便检验一下自己的掌握程度，试试在不回看课程的情况下，自己能不能流畅说出关联的操作细节。</p>
<p>复习之后，我们就来进行最后一次实战演练了。首先会继续改进贯穿课程始终的WordPress网站，把MariaDB改成StatefulSet，加上NFS持久化存储；然后我们会在Kubernetes集群里安装Dashboard，综合实践Ingress、namespace的用法。</p>
<h2>要点回顾一：API对象</h2>
<p>“高级篇”可以分成三个部分，第一部分讲的是PersistentVolume、StatefulSet等API对象。</p>
<p>（[24讲]）<strong>PersistentVolume简称PV，是Kubernetes对持久化存储的抽象</strong>，代表了LocalDisk、NFS、Ceph等存储设备，和CPU、内存一样，属于集群的公共资源。</p>
<p>因为不同存储设备之间的差异很大，为了更好地描述PV特征，就出现了StorageClass，它的作用是分类存储设备，让我们更容易去选择PV对象。</p>
<p>PV一般由系统管理员来创建，我们如果要使用PV就要用PVC（PersistentVolumeClaim）去申请，说清楚需求的容量、访问模式等参数，然后Kubernetes就会查找最合适的PV分配给我们使用。</p>
<p>（[25讲]）手动创建PV的工作量很大，麻烦而且容易出错，所以就有了“动态存储卷”的概念，需要<strong>在StorageClass里绑定一个Provisioner对象，由它来代替人工，根据PVC自动创建出符合要求的PV</strong>。</p>
<p>有了PV和PVC，我们就可以在Pod里用“persistentVolumeClaim”来引用PVC，创建出可供容器使用的Volume，然后在容器里用“volumeMounts”把它挂载到某个路径上，这样容器就可以读写PV，实现数据的持久化存储了。</p>
<p>（[26讲]）持久化存储的一个重要应用领域就是保存应用的状态数据，<strong>管理有状态的应用，就要使用新的对象StatefulSet</strong>，可以认为它是管理无状态应用对象Deployment的一个特例。</p>
<p>StatefulSet对象的YAML描述和Deployment非常像，“spec”里只是多了一个“serviceName”字段，但它部署应用的方式却与Deployment差距很大。</p>
<p>Deployment创建的Pod是随机的名字，而StatefulSet会对Pod顺序编号、顺序创建，保证应用有一个确定的启动先后次序，这样就可以实现主从、主备等关系。</p>
<p>在使用Service为StatefulSet创建服务的时候，它也会为每个Pod单独创建域名，同样也是顺序编号，保证Pod有稳定的网络标识，外部用户就可以用这个域名来准确地访问到某个具体的Pod。</p>
<p>StatefulSet还使用“volumeClaimTemplates”字段来定义持久化存储，里面其实就是一个PVC，每个Pod可以用这个模板来生成自己的PVC去申请PV，实现存储卷与Pod的独立绑定。</p>
<p>通过<strong>启动顺序、稳定域名和存储模板</strong>这三个关键能力，StatefulSet就可以很好地处理Redis、MySQL等有状态应用了。</p>
<h2>要点回顾二：应用管理</h2>
<p>“高级篇”第二部分讲的是应用管理，包括滚动更新、资源配额和健康检查等内容。</p>
<p>（[27讲]）在Kubernetes里部署好应用后，我们还需要对它做持续的运维管理，其中一项任务是版本的更新和回退。</p>
<p>版本更新很简单，只要编写一个新的YAML（Deployment、DaemonSet、StatefulSet），再用 <code>kubectl apply</code> 应用就可以了。Kubernetes采用的是**“滚动更新”策略，实际上是两个同步进行的“扩容”和“缩容”动作**，这样在更新的过程中始终会有Pod处于可用状态，能够平稳地对外提供服务。</p>
<p>应用的更新历史可以用命令 <code>kubectl rollout history</code> 查看，如果有什么意外，就可以用 <code>kubectl rollout undo</code> 来回退。这两个命令相当于给我们的更新流程上了一个保险，可以放心大胆操作，失败就用“S/L大法”。</p>
<p>（[28讲]）为了让Pod里的容器能够稳定运行，我们可以采用<strong>资源配额</strong>和<strong>检查探针</strong>这两种手段。</p>
<p>资源配额能够限制容器申请的CPU和内存数量，不至于过多或者过少，保持在一个合理的程度，更有利于Kubernetes调度。</p>
<p>检查探针是Kubernetes内置的应用监控工具，有Startup、Liveness、Readiness三种，分别探测启动、存活、就绪状态，探测的方式也有exec、tcpSocket、httpGet三种。组合运用这些就可以灵活地检查容器的状态，Kubernetes发现不可用就会重启容器，让应用在总体上处于健康水平。</p>
<h2>要点回顾三：集群管理</h2>
<p>“高级篇”第三部分讲的是集群管理，有名字空间、系统监控和网络通信等知识点。</p>
<p>（[29讲]）Kubernetes的集群里虽然有很多计算资源，但毕竟是有限的，除了要给Pod加上资源配额，我们也要为集群加上资源配额，方法就是用名字空间，把整体的资源池切分成多个小块，按需分配给不同的用户使用。</p>
<p>名字空间的资源配额使用的是“ResourceQuota”，除了基本的CPU和内存，它还能够限制存储容量和各种API对象的数量，这样就可以避免多用户互相挤占，更高效地利用集群资源。</p>
<p>（[30讲]）系统监控是集群管理的另一个重要方面，Kubernetes提供了Metrics Server和Prometheus两个工具：</p>
<ul>
<li><strong>Metrics Server</strong>专门用来收集Kubernetes核心资源指标，可以用 <code>kubectl top</code> 来查看集群的状态，它也是水平自动伸缩对象HorizontalPodAutoscaler的前提条件。</li>
<li><strong>Prometheus</strong>，继Kubernetes之后的第二个CNCF毕业项目，是云原生监控领域的“事实标准”，在集群里部署之后就可以用Grafana可视化监控各种指标，还可以集成自动报警等功能。</li>
</ul>
<p>（[31讲]）对于底层的基础网络设施，Kubernetes定义了平坦的网络模型“IP-per-pod”，实现它就要符合CNI标准。常用的网络插件有Flannel、Calico、Cilium等，Flannel使用Overlay模式，性能较低，Calico使用Route模式，性能较高。</p>
<p>现在，“高级篇”的众多知识要点我们都完整地过了一遍，你是否已经都理解、掌握了它们呢？</p>
<h2>搭建WordPress网站</h2>
<p>接下来我们就来在[第22讲]的基础上继续优化WordPress网站，其中的关键是让数据库MariaDB实现数据持久化。</p>
<p>网站的整体架构图变化不大，前面的Nginx、WordPress还是原样，只需要修改MariaDB：</p>
<p><img src="assets/7cd3726d03ae12172b9073d1abf9fe1b.jpg" alt="图片" /></p>
<p>因为MariaDB由Deployment改成了StatefulSet，所以我们要修改YAML，添加“serviceName”“volumeClaimTemplates”这两个字段，定义网络标识和NFS动态存储卷，然后在容器部分用“volumeMounts”挂载到容器里的数据目录“/var/lib/mysql”。</p>
<p>修改后的YAML就是这个样子：</p>
<pre><code>apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: maria-sts
  name: maria-sts

spec:
  # headless svc
  serviceName: maria-svc

  # pvc
  volumeClaimTemplates:
  - metadata:
      name: maria-100m-pvc
    spec:
      storageClassName: nfs-client
      accessModes:
        - ReadWriteMany
      resources:
        requests:
          storage: 100Mi

  replicas: 1
  selector:
    matchLabels:
      app: maria-sts

  template:
    metadata:
      labels:
        app: maria-sts
    spec:
      containers:
      - image: mariadb:10
        name: mariadb
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 3306

        envFrom:
        - prefix: 'MARIADB_'
          configMapRef:
            name: maria-cm

        volumeMounts:
        - name: maria-100m-pvc
          mountPath: /var/lib/mysql
</code></pre>
<p>改完MariaDB，我们还要再对WordPress做一点小修改。</p>
<p>还记得吗？StatefulSet管理的每个Pod都有自己的域名，所以要把WordPress的环境变量改成MariaDB的新名字，也就是“<strong>maria-sts-0.maria-svc</strong>”：</p>
<pre><code>apiVersion: v1
kind: ConfigMap
metadata:
  name: wp-cm

data:
  HOST: 'maria-sts-0.maria-svc'  #注意这里
  USER: 'wp'
  PASSWORD: '123'
  NAME: 'db'
</code></pre>
<p>改完这两个YAML，我们就可以逐个创建MariaDB、WordPress、Ingress等对象了。</p>
<p>和之前一样，访问NodePort的“30088”端口，或者是用Ingress Controller的“wp.test”域名，都可以进入WordPress网站：</p>
<p><img src="assets/fc3b52f96f138f01b23e3a7487730746.png" alt="图片" /></p>
<p>StatefulSet的持久化存储是否生效了呢？</p>
<p>你可以把这些对象都删除后重新创建，再进入网站，看看是否原来的数据依然存在。或者更简单一点，直接查看NFS的存储目录，应该可以看到MariaDB生成的一些数据库文件：</p>
<p><img src="assets/428886b77e4797dc7ded5a43yyc0b218.png" alt="图片" /></p>
<p>这两种方式都能够证明，我们的MariaDB使用StatefulSet部署后数据已经保存在了磁盘上，不会因为对象的销毁而丢失。</p>
<p>到这里，第一个小实践你就已经完成了，给自己鼓鼓劲，我们一起来做第二个实践，在Kubernetes集群里安装Dashboard。</p>
<h2>部署Dashboard</h2>
<p>在“初级篇”的实战演练课里（[第15讲]），我简单介绍了Kubernetes的图形管理界面，也就是Dashboard，不知道你是否还有印象。当时Dashboard是直接内置在minikube里的，不需要安装，一个命令启动，就能在浏览器里直观地管理Kubernetes集群了，非常方便。</p>
<p>那现在我们用kubeadm部署了实际的多节点集群，能否也用上Dashboard呢？接下来我就带你来一起动手，从零开始安装Dashboard。</p>
<p>首先，你应该先去Dashboard的项目网站（<a href="https://github.com/kubernetes/dashboard">https://github.com/kubernetes/dashboard</a>），看一下它的说明文档，了解一下它的基本情况。</p>
<p>它的安装很简单，只需要一个YAML文件，可以直接下载：</p>
<pre><code>wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.6.0/aio/deploy/recommended.yaml
</code></pre>
<p>这个YAML里包含了很多对象，虽然文件比较大，但现在的你应该基本都能够看懂了，要点有这么几个：</p>
<ul>
<li>所有的对象都属于“kubernetes-dashboard”名字空间。</li>
<li>Dashboard使用Deployment部署了一个实例，端口号是8443。</li>
<li>容器启用了Liveness探针，使用HTTPS方式检查存活状态。</li>
<li>Service对象使用的是443端口，它映射了Dashboard的8443端口。</li>
</ul>
<p>使用命令 <code>kubectl apply</code> 就可以轻松部署Dashboard了：</p>
<pre><code>kubectl apply -f dashboard.yaml
</code></pre>
<p><img src="assets/c56f8936e187047a2b7d100f7ae0f779.png" alt="图片" /></p>
<h2>部署Ingress/Ingress Controller</h2>
<p>不过，为了给我们的实战增加一点难度，我们可以在前面配一个Ingress入口，用反向代理的方式来访问它。</p>
<p>由于Dashboard默认使用的是加密的HTTPS协议，拒绝明文HTTP访问，所以我们要先生成证书，让Ingress也走HTTPS协议。</p>
<p>简单起见，我直接用Linux里的命令行工具“openssl”来生成一个自签名的证书（如果你有条件，也可以考虑找CA网站申请免费证书）：</p>
<pre><code>openssl req -x509 -days 365 -out k8s.test.crt -keyout k8s.test.key \
  -newkey rsa:2048 -nodes -sha256 \
    -subj '/CN=k8s.test' -extensions EXT -config &lt;( \
       printf &quot;[dn]\nCN=k8s.test\n[req]\ndistinguished_name = dn\n[EXT]\nsubjectAltName=DNS:k8s.test\nkeyUsage=digitalSignature\nextendedKeyUsage=serverAuth&quot;)
</code></pre>
<p>openssl的命令比较长，我简单解释一下：它生成的是一个X509格式的证书，有效期365天，私钥是RSA2048位，摘要算法是SHA256，签发的网站是“k8s.test”。</p>
<p>运行命令行后会生成两个文件，一个是证书“k8s.test.crt”，另一个是私钥“k8s.test.key”，我们需要把这两个文件存入Kubernetes里供Ingress使用。</p>
<p>因为这两个文件属于机密信息，存储的方式当然就是用Secret了。你仍然可以用命令 <code>kubectl create secret</code> 来自动创建YAML，不过类型不是“generic”，而是“tls”，同时还要用 <code>-n</code> 指定名字空间，用 <code>--cert</code>、<code>--key</code> 指定文件：</p>
<pre><code>export out=&quot;--dry-run=client -o yaml&quot;
kubectl create secret tls dash-tls -n kubernetes-dashboard --cert=k8s.test.crt --key=k8s.test.key $out &gt; cert.yml
</code></pre>
<p>出来的YAML大概是这个样子：</p>
<pre><code>apiVersion: v1
kind: Secret
metadata:
  name: dash-tls
  namespace: kubernetes-dashboard
type: kubernetes.io/tls

data:
  tls.crt: LS0tLS1CRUdJTiBDRVJU...
  tls.key: LS0tLS1CRUdJTiBQUklW...
</code></pre>
<p>创建这个Secret对象之后，你可以再用 <code>kubectl describe</code> 来检查它的状态：</p>
<p><img src="assets/2615d5c6c3yy704cc63c5bf6df5b87cc.png" alt="图片" /></p>
<p>接下来我们就来编写Ingress Class和Ingress对象，为了保持名字空间的整齐，也把它放在“kubernetes-dashboard”名字空间里。</p>
<p>Ingress Class对象很简单，名字是“dash-ink”，指定Controller还是我们之前用的Nginx官方的Ingress Controller：</p>
<pre><code>apiVersion: networking.k8s.io/v1
kind: IngressClass

metadata:
  name: dash-ink
  namespace: kubernetes-dashboard
spec:
  controller: nginx.org/ingress-controller
</code></pre>
<p>Ingress对象可以用 <code>kubectl create</code> 命令自动生成，如果你有点忘记的话，可以回头参考一下[第21讲]：</p>
<pre><code>kubectl create ing dash-ing --rule=&quot;k8s.test/=kubernetes-dashboard:443&quot; --class=dash-ink -n kubernetes-dashboard $out
</code></pre>
<p>但这次因为是HTTPS协议，所以我们要在Ingress里多加一点东西，一个是“<strong>annotations</strong>”字段，指定后端目标是HTTPS服务，另一个是“<strong>tls</strong>”字段，指定域名和证书，也就是刚才创建的Secret：</p>
<pre><code>apiVersion: networking.k8s.io/v1
kind: Ingress

metadata:
  name: dash-ing
  namespace: kubernetes-dashboard
  annotations:
    nginx.org/ssl-services: &quot;kubernetes-dashboard&quot;

spec:
  ingressClassName: dash-ink

  tls:
    - hosts:
      - k8s.test
      secretName: dash-tls

  rules:
  - host: k8s.test
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: kubernetes-dashboard
            port:
              number: 443
</code></pre>
<p>最后一个对象，就是Ingress Controller了，还是拿现成的模板修改，记得要把“args”里的Ingress Class改成我们自己的“dash-ink”：</p>
<pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: dash-kic-dep
  namespace: nginx-ingress

spec:
  ...
        args:
          - -ingress-class=dash-ink
</code></pre>
<p>要让我们在外面能够访问Ingress Controller，还要为它再定义一个Service，类型是“NodePort”，端口指定是“30443”：</p>
<pre><code>apiVersion: v1
kind: Service
metadata:
  name: dash-kic-svc
  namespace: nginx-ingress

spec:
  ports:
  - port: 443
    protocol: TCP
    targetPort: 443
    nodePort: 30443

  selector:
    app: dash-kic-dep
  type: NodePort
</code></pre>
<p>把上面的Secret、Ingress Class、Ingress、Ingress Controller、Service都创建好之后，我们再来确认一下它们的运行状态：</p>
<p><img src="assets/4062d4e5c8c57f74a480ee21ca3717b2.png" alt="图片" /></p>
<p>因为这些对象比较多，处于不同的名字空间，关联有点复杂，我画了一个简单的示意图，你可以看一下：</p>
<p><img src="assets/b720648a0fefab28fa940b7cd6afb350.jpg" alt="图片" /></p>
<h2>访问Dashboard</h2>
<p>到这里，Dashboard的部署工作就基本完成了。为了能正常访问，我们还要为它创建一个用户，才能登录进Dashboard。</p>
<p>Dashboard的网站上有一个简单示例（<a href="https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md">https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md</a>），我们直接拿来用就行：</p>
<pre><code>apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kubernetes-dashboard

---

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kubernetes-dashboard
</code></pre>
<p>这个YAML创建了一个Dashboard的管理员账号，名字叫“admin-user”，使用的是Kubernetes的RBAC机制，就不展开细讲了。</p>
<p>这个账号不能用简单的“用户名+密码”的方式登录，需要用到一个Token，可以用 <code>kubectl get secret</code>、<code>kubectl describe secret</code> 查到：</p>
<pre><code>kubectl get secret -n kubernetes-dashboard
kubectl describe secrets -n kubernetes-dashboard admin-user-token-xxxx
</code></pre>
<p><img src="assets/0ffd4627b0efa2ba5774bf5c65faa1yy.png" alt="图片" /></p>
<p>Token是一个很长的字符串，把它拷贝存好，再为它的测试域名“k8s.test”加上域名解析（修改/etc/hosts），然后我们就可以在浏览器里输入网址“<a href="https://k8s.test:30443">https://k8s.test:30443</a>”访问Dashboard了：</p>
<p><img src="assets/c83cd71ab4d6696f5b837ea20056ff5d.png" alt="图片" /></p>
<p>下面的两张截图就是我查看集群里“kube-system”名字空间的情况，由于我们之前安装了Metrics Server，所以Dashboard也能够以图形的方式显示CPU和内存状态，有那么一点Prometheus + Grafana的意思：</p>
<p><img src="assets/3ca6e156150a6a06477bb2eb07e00cd9.png" alt="图片" /></p>
<p><img src="assets/fae2168c30677d2370e8e71c3d98f1b2.png" alt="图片" /></p>
<h2>小结</h2>
<p>好了，今天我们一起回顾了“高级篇”里的要点，下面的这张思维导图就是对这些知识点的全面总结，你可以再认真研究一下：</p>
<p><img src="assets/4a9bb79b2e54096yyf5c5799837dd930.jpg" alt="图片" /></p>
<p>今天我们有两个实战项目。首先是WordPress，把后端的存储服务MariaDB改造成了StatefulSet，挂载了NFS网盘，这样就实现了一个功能比较完善的网站，达到了基本可用的程度。</p>
<p>接着我们又在Kubernetes里安装了Dashboard，主要部署在名字空间“kubernetes-dashboard”。Dashboard自身的安装很简单，但我们又为它在前面搭建了一个反向代理，配上了安全证书，进一步实践了Ingress的用法。</p>
<p>不过这两个项目还没有完全覆盖“高级篇”的内容，你可以再接着改进它们，比如加上健康检查、资源配额、自动水平伸缩等，多动手来巩固所学的知识。</p>
<h2>课下作业</h2>
<p>今天的课下作业时间，我想就留给你自己来操作一下这节课里的两个实战演练吧，如果遇到了什么问题，可以在留言区随时提问。</p>
<p><img src="assets/aa71ca9df15c8141f3368cce8b41dc9f.jpg" alt="图片" /></p>
</div>
                        </div>
                        <div>
                            <div style="float: left">
                                <a href="31%20%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%EF%BC%9ACNI%E6%98%AF%E6%80%8E%E4%B9%88%E5%9B%9E%E4%BA%8B%EF%BC%9F%E5%8F%88%E6%98%AF%E6%80%8E%E4%B9%88%E5%B7%A5%E4%BD%9C%E7%9A%84%EF%BC%9F.md.html">上一页</a>
                            </div>
                            <div style="float: right">
                                <a href="33%20%E8%A7%86%E9%A2%91%EF%BC%9A%E9%AB%98%E7%BA%A7%E7%AF%87%E5%AE%9E%E6%93%8D%E6%80%BB%E7%BB%93.md.html">下一页</a>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="copyright"><p>© 2019 - 2023 <a href="../../cdn-cgi/l/email-protection.html#8fe3e3e3b6bbbebebfb8cfe8e2eee6e3a1ece0e2" target="_blank">Liangliang Lee</a>. Powered by <a href="https://vertx.io/" target="_blank">Vert.x</a> and <a href="https://github.com/kaiiiz/hexo-theme-book" target="_blank">hexo-theme-book</a>.</p></div>
        </div>

        <a class="off-canvas-overlay" onclick="hide_canvas()"></a>
    </div>
<script data-cfasync="false" src="../../cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/vb26e4fa9e5134444860be286fd8771851679335129114" integrity="sha512-M3hN/6cva/SjwrOtyXeUa5IuCT0sedyfT+jK/OV+s+D0RnzrTfwjwJHhd+wYfMm9HJSrZ1IKksOdddLuN6KOzw==" data-cf-beacon='{"rayId":"7aef6b44da3b641c","version":"2023.3.0","r":1,"token":"1f5d475227ce4f0089a7cff1ab17c0f5","si":100}' crossorigin="anonymous"></script>
</body>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NPSEEVD756"></script>
<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'G-NPSEEVD756');
    var path = window.location.pathname
    var cookie = getCookie("lastPath");
    console.log(path)
    if (path.replace("/", "") === "") {
        if (cookie.replace("/", "") !== "") {
            console.log(cookie)
            document.getElementById("tip").innerHTML = "<a href='" + cookie + "'>跳转到上次进度</a>"
        }
    } else {
        setCookie("lastPath", path)
    }

    function setCookie(cname, cvalue) {
        var d = new Date();
        d.setTime(d.getTime() + (180 * 24 * 60 * 60 * 1000));
        var expires = "expires=" + d.toGMTString();
        document.cookie = cname + "=" + cvalue + "; " + expires + ";path = /";
    }

    function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i].trim();
            if (c.indexOf(name) === 0) return c.substring(name.length, c.length);
        }
        return "";
    }

    hljs.initHighlightingOnLoad()

</script>

</html>
