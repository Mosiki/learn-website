<!DOCTYPE html>
<!-- saved from url=(0046)https://kaiiiz.github.io/hexo-theme-book-demo/ -->
<html xmlns="http://www.w3.org/1999/xhtml">

<head>

    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
        <link rel="icon" href="../../static/favicon.png">
        <title>10 搜索引擎设计：信息搜索怎么避免大海捞针？.md</title>
        <!-- Spectre.css framework -->
        <link rel="stylesheet" href="../../static/index.css">
        <link rel="stylesheet"
              href="../../static/highlight.min.css">
        <script src="../../static/highlight.min.js"></script>
        <!-- theme css & js -->
        <meta name="generator" content="Hexo 4.2.0">
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5295275829820252"
                crossorigin="anonymous"></script>
        <script async defer data-website-id="83e5d5db-9d06-40e3-b780-cbae722fdf8c" src="https://analyze.lianglianglee.com/umami.js"></script>
    </head>

<body>

    <div class="book-container">
        <div class="book-sidebar">
            <div class="book-brand">
                <a href="../../index.html">
                    <img src="../../static/favicon.png">
                    <span>技术文章摘抄</span>
                </a>
            </div>
            <div class="book-menu uncollapsible">
                <ul class="uncollapsible">
                    <li><a href="../../index.html" class="current-tab">首页</a></li>
                </ul>

                <ul class="uncollapsible">
                    <li><a href="../index.html">上一级</a></li>
                </ul>

                <ul class="uncollapsible">
                    <li>

                        
                        <a href="00%20%E5%BC%80%E7%AF%87%E8%AF%8D%20%E2%80%9C%E9%99%84%E8%BA%AB%E2%80%9D%E5%A4%A7%E5%8E%82%E6%9E%B6%E6%9E%84%E5%B8%88%EF%BC%8C%E8%BA%AB%E4%B8%B4%E5%85%B6%E5%A2%83%E8%AE%BE%E8%AE%A1%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F.md.html">00 开篇词 “附身”大厂架构师，身临其境设计高并发系统.md</a>

                    </li>
                    <li>

                        
                        <a href="01%20%E8%BD%AF%E4%BB%B6%E5%BB%BA%E6%A8%A1%E4%B8%8E%E6%96%87%E6%A1%A3%EF%BC%9A%E6%9E%B6%E6%9E%84%E5%B8%88%E6%80%8E%E6%A0%B7%E7%BB%98%E5%88%B6%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E8%93%9D%E5%9B%BE%EF%BC%9F.md.html">01 软件建模与文档：架构师怎样绘制系统架构蓝图？.md</a>

                    </li>
                    <li>

                        
                        <a href="02%20%E9%AB%98%E5%B9%B6%E5%8F%91%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%B3%95%EF%BC%9A%E9%9D%A2%E5%AF%B9%E9%AB%98%E5%B9%B6%E5%8F%91%EF%BC%8C%E6%80%8E%E4%B9%88%E5%AF%B9%E7%97%87%E4%B8%8B%E8%8D%AF%EF%BC%9F.md.html">02 高并发架构设计方法：面对高并发，怎么对症下药？.md</a>

                    </li>
                    <li>

                        
                        <a href="03%20%E7%9F%AD%20URL%20%E7%94%9F%E6%88%90%E5%99%A8%E8%AE%BE%E8%AE%A1%EF%BC%9A%E7%99%BE%E4%BA%BF%E7%9F%AD%20URL%20%E6%80%8E%E6%A0%B7%E5%81%9A%E5%88%B0%E6%97%A0%E5%86%B2%E7%AA%81%EF%BC%9F.md.html">03 短 URL 生成器设计：百亿短 URL 怎样做到无冲突？.md</a>

                    </li>
                    <li>

                        
                        <a href="04%20%E7%BD%91%E9%A1%B5%E7%88%AC%E8%99%AB%E8%AE%BE%E8%AE%A1%EF%BC%9A%E5%A6%82%E4%BD%95%E4%B8%8B%E8%BD%BD%E5%8D%83%E4%BA%BF%E7%BA%A7%E7%BD%91%E9%A1%B5%EF%BC%9F.md.html">04 网页爬虫设计：如何下载千亿级网页？.md</a>

                    </li>
                    <li>

                        
                        <a href="05%20%E7%BD%91%E7%9B%98%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%EF%BC%9A%E4%B8%87%E4%BA%BF%20GB%20%E7%BD%91%E7%9B%98%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%A7%92%E4%BC%A0%E4%B8%8E%E9%99%90%E9%80%9F%EF%BC%9F.md.html">05 网盘系统设计：万亿 GB 网盘如何实现秒传与限速？.md</a>

                    </li>
                    <li>

                        
                        <a href="06%20%E7%9F%AD%E8%A7%86%E9%A2%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%EF%BC%9A%E5%A6%82%E4%BD%95%E6%94%AF%E6%8C%81%E4%B8%89%E5%8D%83%E4%B8%87%E7%94%A8%E6%88%B7%E5%90%8C%E6%97%B6%E5%9C%A8%E7%BA%BF%E7%9C%8B%E8%A7%86%E9%A2%91%EF%BC%9F.md.html">06 短视频系统设计：如何支持三千万用户同时在线看视频？.md</a>

                    </li>
                    <li>

                        
                        <a href="07%20%E6%B5%B7%E9%87%8F%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E6%8A%80%E6%9C%AF%E5%9B%9E%E9%A1%BE%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88%E5%88%86%E5%B8%83%E5%BC%8F%E4%BC%9A%E9%81%87%E5%88%B0%20CAP%20%E9%9A%BE%E9%A2%98%EF%BC%9F.md.html">07 海量数据处理技术回顾：为什么分布式会遇到 CAP 难题？.md</a>

                    </li>
                    <li>

                        
                        <a href="08%20%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%EF%BC%9A%E4%BD%A0%E7%9A%84%E7%B3%BB%E7%BB%9F%E5%8F%AF%E4%BB%A5%E5%BA%94%E5%AF%B9%E4%B8%87%E4%BA%BA%E6%8A%A2%E8%B4%AD%E7%9B%9B%E5%86%B5%E5%90%97%EF%BC%9F.md.html">08 秒杀系统设计：你的系统可以应对万人抢购盛况吗？.md</a>

                    </li>
                    <li>

                        
                        <a href="09%20%E4%BA%A4%E5%8F%8B%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%EF%BC%9A%E5%93%AA%E7%A7%8D%E5%9C%B0%E7%90%86%E7%A9%BA%E9%97%B4%E9%82%BB%E8%BF%91%E7%AE%97%E6%B3%95%E6%9B%B4%E5%BF%AB%EF%BC%9F.md.html">09 交友系统设计：哪种地理空间邻近算法更快？.md</a>

                    </li>
                    <li>

                        <a class="current-tab" href="10%20%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E8%AE%BE%E8%AE%A1%EF%BC%9A%E4%BF%A1%E6%81%AF%E6%90%9C%E7%B4%A2%E6%80%8E%E4%B9%88%E9%81%BF%E5%85%8D%E5%A4%A7%E6%B5%B7%E6%8D%9E%E9%92%88%EF%BC%9F.md.html">10 搜索引擎设计：信息搜索怎么避免大海捞针？.md</a>
                        

                    </li>
                    <li>

                        
                        <a href="11%20%E5%8F%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1%EF%BC%9A%E5%A6%82%E4%BD%95%E4%BD%BF%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E6%97%A0%E9%98%BB%E5%A1%9E%E7%AD%89%E5%BE%85%EF%BC%9F.md.html">11 反应式编程框架设计：如何使方法调用无阻塞等待？.md</a>

                    </li>
                    <li>

                        
                        <a href="12%20%E9%AB%98%E6%80%A7%E8%83%BD%E6%9E%B6%E6%9E%84%E7%9A%84%E4%B8%89%E6%9D%BF%E6%96%A7%EF%BC%9A%E5%88%86%E6%9E%90%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98%E4%BB%8E%E5%93%AA%E9%87%8C%E5%85%A5%E6%89%8B%EF%BC%9F.md.html">12 高性能架构的三板斧：分析系统性能问题从哪里入手？.md</a>

                    </li>
                    <li>

                        
                        <a href="13%20%E5%BE%AE%E5%8D%9A%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%EF%BC%9A%E6%80%8E%E4%B9%88%E5%BA%94%E5%AF%B9%E7%83%AD%E7%82%B9%E4%BA%8B%E4%BB%B6%E7%9A%84%E7%AA%81%E5%8F%91%E8%AE%BF%E9%97%AE%E5%8E%8B%E5%8A%9B%EF%BC%9F.md.html">13 微博系统设计：怎么应对热点事件的突发访问压力？.md</a>

                    </li>
                    <li>

                        
                        <a href="14%20%E7%99%BE%E7%A7%91%E5%BA%94%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%EF%BC%9A%E6%9C%BA%E6%88%BF%E8%A2%AB%E7%81%AB%E7%83%A7%E4%BA%86%E7%B3%BB%E7%BB%9F%E8%BF%98%E8%83%BD%E8%AE%BF%E9%97%AE%E5%90%97%EF%BC%9F.md.html">14 百科应用系统设计：机房被火烧了系统还能访问吗？.md</a>

                    </li>
                    <li>

                        
                        <a href="15%20%E9%99%90%E6%B5%81%E5%99%A8%E8%AE%BE%E8%AE%A1%EF%BC%9A%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%E8%B6%85%E9%A2%84%E6%9C%9F%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%8E%8B%E5%8A%9B%E5%8E%8B%E5%9E%AE%E7%B3%BB%E7%BB%9F%EF%BC%9F.md.html">15 限流器设计：如何避免超预期的高并发压力压垮系统？.md</a>

                    </li>
                    <li>

                        
                        <a href="16%20%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84%E7%9A%84%E5%8D%81%E7%A7%8D%E6%AD%A6%E5%99%A8%EF%BC%9A%E6%80%8E%E4%B9%88%E5%BA%A6%E9%87%8F%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%8F%AF%E7%94%A8%E6%80%A7%EF%BC%9F.md.html">16 高可用架构的十种武器：怎么度量系统的可用性？.md</a>

                    </li>
                    <li>

                        
                        <a href="17%20Web%20%E5%BA%94%E7%94%A8%E9%98%B2%E7%81%AB%E5%A2%99%EF%BC%9A%E6%80%8E%E6%A0%B7%E6%8B%A6%E6%88%AA%E6%81%B6%E6%84%8F%E7%94%A8%E6%88%B7%E7%9A%84%E9%9D%9E%E6%B3%95%E8%AF%B7%E6%B1%82%EF%BC%9F.md.html">17 Web 应用防火墙：怎样拦截恶意用户的非法请求？.md</a>

                    </li>
                    <li>

                        
                        <a href="18%20%E5%8A%A0%E8%A7%A3%E5%AF%86%E6%9C%8D%E5%8A%A1%E5%B9%B3%E5%8F%B0%EF%BC%9A%E5%A6%82%E4%BD%95%E8%AE%A9%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E4%B8%8E%E4%BC%A0%E8%BE%93%E6%9B%B4%E5%AE%89%E5%85%A8%EF%BC%9F.md.html">18 加解密服务平台：如何让敏感数据存储与传输更安全？.md</a>

                    </li>
                    <li>

                        
                        <a href="19%20%E8%AE%B8%E5%8F%AF%E5%9E%8B%E5%8C%BA%E5%9D%97%E9%93%BE%E9%87%8D%E6%9E%84%EF%BC%9A%E6%97%A0%E4%B8%AD%E5%BF%83%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E6%80%8E%E4%B9%88%E5%81%9A%E5%88%B0%E5%8F%AF%E4%BF%A1%E4%BB%BB%EF%BC%9F.md.html">19 许可型区块链重构：无中心的区块链怎么做到可信任？.md</a>

                    </li>
                    <li>

                        
                        <a href="20%20%E7%BD%91%E7%BA%A6%E8%BD%A6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%EF%BC%9A%E6%80%8E%E6%A0%B7%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E6%97%A5%E8%B5%9A%205%20%E4%BA%BF%E7%9A%84%E7%BD%91%E7%BA%A6%E8%BD%A6%E7%B3%BB%E7%BB%9F%EF%BC%9F.md.html">20 网约车系统设计：怎样设计一个日赚 5 亿的网约车系统？.md</a>

                    </li>
                    <li>

                        
                        <a href="21%20%E7%BD%91%E7%BA%A6%E8%BD%A6%E7%B3%BB%E7%BB%9F%E9%87%8D%E6%9E%84%EF%BC%9A%E5%A6%82%E4%BD%95%E7%94%A8%20DDD%20%E9%87%8D%E6%9E%84%E7%BD%91%E7%BA%A6%E8%BD%A6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%EF%BC%9F.md.html">21 网约车系统重构：如何用 DDD 重构网约车系统设计？.md</a>

                    </li>
                    <li>

                        
                        <a href="22%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%B9%B3%E5%8F%B0%E8%AE%BE%E8%AE%A1%EF%BC%9A%E5%A6%82%E4%BD%95%E7%94%A8%E6%95%B0%E6%8D%AE%E4%B8%BA%E7%94%A8%E6%88%B7%E5%88%9B%E9%80%A0%E4%BB%B7%E5%80%BC%EF%BC%9F.md.html">22 大数据平台设计：如何用数据为用户创造价值？.md</a>

                    </li>
                    <li>

                        
                        <a href="%E7%BB%93%E6%9D%9F%E8%AF%AD%20%E4%B8%80%E4%B8%AA%E6%9E%B6%E6%9E%84%E5%B8%88%E7%9A%84%E4%B8%80%E5%A4%A9.md.html">结束语 一个架构师的一天.md</a>

                    </li>
                </ul>

            </div>
        </div>

        <div class="sidebar-toggle" onclick="sidebar_toggle()" onmouseover="add_inner()" onmouseleave="remove_inner()">
            <div class="sidebar-toggle-inner"></div>
        </div>

        <script>
            function add_inner() {
                let inner = document.querySelector('.sidebar-toggle-inner')
                inner.classList.add('show')
            }

            function remove_inner() {
                let inner = document.querySelector('.sidebar-toggle-inner')
                inner.classList.remove('show')
            }

            function sidebar_toggle() {
                let sidebar_toggle = document.querySelector('.sidebar-toggle')
                let sidebar = document.querySelector('.book-sidebar')
                let content = document.querySelector('.off-canvas-content')
                if (sidebar_toggle.classList.contains('extend')) { // show
                    sidebar_toggle.classList.remove('extend')
                    sidebar.classList.remove('hide')
                    content.classList.remove('extend')
                } else { // hide
                    sidebar_toggle.classList.add('extend')
                    sidebar.classList.add('hide')
                    content.classList.add('extend')
                }
            }


            function open_sidebar() {
                let sidebar = document.querySelector('.book-sidebar')
                let overlay = document.querySelector('.off-canvas-overlay')
                sidebar.classList.add('show')
                overlay.classList.add('show')
            }
            function hide_canvas() {
                let sidebar = document.querySelector('.book-sidebar')
                let overlay = document.querySelector('.off-canvas-overlay')
                sidebar.classList.remove('show')
                overlay.classList.remove('show')
            }

        </script>

        <div class="off-canvas-content">
            <div class="columns">
                <div class="column col-12 col-lg-12">
                    <div class="book-navbar">
                        <!-- For Responsive Layout -->
                        <header class="navbar">
                            <section class="navbar-section">
                                <a onclick="open_sidebar()">
                                    <i class="icon icon-menu"></i>
                                </a>
                            </section>
                        </header>
                    </div>
                    <div class="book-content" style="max-width: 960px; margin: 0 auto;
    overflow-x: auto;
    overflow-y: hidden;">
                        <div class="book-post">
                            <p id="tip" align="center"></p>
                            <div><h1>10 搜索引擎设计：信息搜索怎么避免大海捞针？</h1>
<p>你好，我是李智慧。</p>
<p>在[04讲]中，我们讨论了大型分布式网络爬虫的架构设计，但是网络爬虫只是从互联网获取信息，海量的互联网信息如何呈现给用户，还需要使用搜索引擎完成。因此，我们准备开发一个针对全网内容的搜索引擎，产品名称为“Bingoo”。</p>
<p>Bingoo的主要技术挑战包括：</p>
<ol>
<li>针对爬虫获取的海量数据，如何高效地进行数据管理；</li>
<li>当用户输入搜索词的时候，如何快速查找包含搜索词的网页内容；</li>
<li>如何对搜索结果的网页内容进行排序，使排在搜索结果列表前面的网页，正好是用户期望看到的内容。</li>
</ol>
<h2>概要设计</h2>
<p>一个完整的搜索引擎包括分布式爬虫、索引构造器、网页排名算法、搜索器等组成部分，Bingoo的系统架构如下。</p>
<p><img src="assets/4b1d91247766bacb920a4af7bd8ec09d.jpg" alt="图片" /></p>
<p>分布式爬虫通过存储服务器将爬取的网页存储到分布式文件集群HDFS，为了提高存储效率，网页将被压缩后存储。存储的时候，网页一个文件挨着一个文件地连续存储，存储格式如下。</p>
<p><img src="assets/fa2bb56330b9ab2d3dd78e5c379f1599.jpg" alt="图片" /></p>
<p>每个网页被分配得到一个8字节长整型docID，docID之后用2个字节记录网页的URL的长度，之后4个字节记录压缩后网页内容数据的长度，所有存储的网页的头14个字节都是同样的格式。之后存储URL字符串和压缩后的网页内容数据。读取文件的时候，先读14个字节的头信息，根据头信息中记录的URL长度和数据长度，再读取对应长度的URL和网页内容数据。</p>
<p>搜索引擎能够快速查找的核心就是利用索引，根据用户的查询内容查找匹配的索引，根据索引列表构建结果页面。索引的构造主要通过索引构造器完成，索引构造器读取HDFS中的网页内容，解压缩后提取网页中的单词，构建一个“docID-&gt;单词列表”的正排索引。然后，索引构造器再根据这个正排索引构建一个“单词-&gt;docID列表”的倒排索引，“docID列表”就是包含了这个单词的所有网页列表。利用这个倒排索引，搜索器可以快速获得用户搜索词对应的所有网页。</p>
<p>网页中所有的单词构成了一个词典，实际上，词典就是一个Hash表，key就是单词，value就是倒排索引的网页列表。虽然互联网页的内容非常庞大，但是使用到的单词其实是非常有限的。根据Google的报告，256M内存可以存放1400万个单词，这差不多就是英文单词的全部了。</p>
<p>在构建索引的过程中，因为要不断修改索引列表，还要进行排序，所以，有很多操作是需要进行加锁同步完成的。对于海量的互联网页的计算，这样的索引构建速度太慢了。因此我们设计了64个索引桶，根据docID取模，将不同网页分配到不同的桶中，在每个桶中分别进行索引构建，通过并行计算来加快索引处理速度。</p>
<p>索引构造器在读取网页内容、构造索引的时候，还会调用URL提取器，将网页中包含的URL提取出来，构建一个链接关系表。链接关系表的格式是“docID-&gt;docID”，前一个docID是当前网页的docID，后一个docID是当前网页中包含的URL对应的docID。一个网页中会包含很多个URL，也就是会构建出很多个这样的链接关系。后面会利用这个链接关系表，使用PageRank排名算法对所有网页进行打分排名，当索引器得到查找的网页列表时，利用PageRank值进行排名，最终呈现给用户，保证用户最先看到的网页是最接近用户期望的结果页面。</p>
<h2>详细设计</h2>
<p>一个运行良好的搜索引擎的核心技术就是索引和排名，所以我们将分别说明这两种技术要点。</p>
<h4>索引</h4>
<p>索引构造器从HDFS读取网页内容后，解析每个页面，提取网页里的每个单词。如果是英文，那么每个单词都用空格分隔，比较容易；如果是中文，需要使用中文分词器才能提取到每个单词，比如“高并发架构”，使用中文分词器得到的就是“高并发”、“架构”两个词。</p>
<p>首先，索引构造器将所有的网页都读取完，构建出所有的“docID-&gt;单词列表”正排索引。</p>
<p><img src="assets/82a7104f75267b7bd0158b5755567809.jpg" alt="图片" /></p>
<p>然后遍历所有的正排索引，再按照“单词→docID列表”的方式组织起来，就是倒排索引了。</p>
<p><img src="assets/d67b951a58e1ab8d0c79d908f1e7e361.jpg" alt="图片" /></p>
<p>我们这个例子中只有两个单词、7个网页。事实上，Bingoo数以千亿的网页就是这样通过倒排索引组织起来的，网页数量虽然庞大，但是单词数却是比较有限的。所以，整个倒排索引的大小相比于网页数量要小得多。Bingoo将每个单词对应的网页列表存储在硬盘中，而单词则存储在内存的Hash表，也就是词典中，词典示例：</p>
<p><img src="assets/b3612d6a169fca54946f300b17644d41.jpg" alt="图片" /></p>
<p>对于部分热门的单词，整个网页列表也可以存储在内存中，相当于缓存。在词典中，每个单词记录下硬盘或者内存中的网页列表地址，这样只要搜索单词，就可以快速得到对应的网页地址列表。Bingoo根据列表中的网页编号docID，展示对应的网页信息摘要，就完成了海量数据的快速检索。</p>
<p>如果用户的搜索词正好是一个单词，比如“高并发”，那么直接查找词典，得到网页列表就完成查找了。但是如果用户输入的是一个句话，那么搜索器就需要将这句话拆分成几个单词，然后分别查找倒排索引。这样的话，得到的就是几个网页列表，还需要对这几个网页列表求交集，才能得到最终的结果列表。</p>
<p>比如，用户输入“高并发架构”进行搜索，那么搜索器就会拆分成两个词：“高并发”、“架构”，得到两个倒排索引：</p>
<p>高并发-&gt;2,3,5,7</p>
<p>架构-&gt;1,2,4</p>
<p>需要对这两个倒排索引求交集，也就是同时包含“高并发”和“架构”的网页才是符合搜索要求的结果，最终的交集结果应该是只有一篇网页，即docID为2的满足要求。</p>
<p>列表求交集最简单的实现就是双层for循环，但是这种算法的时间复杂度是O(n^2)，我们的网页列表长度（n）可能有千万级甚至更高，这样的计算效率太低。</p>
<p>一个改进的算法是<strong>拉链法</strong>，我们将网页列表先按照docID的编号进行排序，得到的就是这样两个有序链表：</p>
<p><img src="assets/6422e8ac0da90ffcb1218552a4471d84.jpg" alt="图片" /></p>
<p>同时遍历两个链表，如果其中一个链表当前指向的元素小于另一个链表当前指向的元素，那么这个链表就继续向前遍历；如果两个链表当前指向的元素相同，该元素就是交集元素，记录在结果列表中；依此继续向前遍历，直到其中一个链表指向自己的尾部nil。</p>
<p>拉链法的时间复杂度是O(2n)，远优于双层循环。但是对于千万级的数据而言，还是太慢。我们还可以采用<strong>数据分片</strong>的方式进行并行计算，以实现性能优化。</p>
<p>比如，我们的docID分布在[0, 1万亿)区间，而每个倒排索引链表平均包含1千万个docID。我们把所有的docID按照1千亿进行数据分片，就会得到10个区间[0, 1千亿)[1千亿，2千亿)……[9千亿，1万亿)。每个倒排索引链表大致均匀分布在这10个区间，我们就可以依照这10个区间范围，将每个要遍历的链表切分为10片，每片大约包含1百万个docID。两个链表只在自己对应的分片内求交集即可，因此我们可以启动10个线程对10个分片进行并行计算，速度可提高10倍。</p>
<p>事实上，两个1千万长度的链表求交集，最终的结果可能不过几万，也就是说，大部分的比较都是不相等的。比如下面的例子。</p>
<p><img src="assets/1f17583a47a03498f0bd7bc6ab426194.jpg" alt="图片" /></p>
<p>第一个链表遍历到自己的最后一个元素，才和第二个链表的第一个元素相同。那么第一个链表能不能跳过前面那些元素呢？很自然，我们想到可以用<strong>跳表</strong>来实现，如下图。</p>
<p><img src="assets/c178c81263abfcd21e4b836d724347cb.jpg" alt="图片" /></p>
<p><strong>跳表实际上是在链表上构建多级索引</strong>，在索引上遍历可以跳过底层的部分数据，我们可以利用这个特性实现链表的跳跃式比较，加快计算速度。使用跳表的交集计算时间复杂度大约是O(log(n))。</p>
<p>此外，虽然搜索引擎利用倒排索引已经能很快得到搜索结果了，但搜索引擎应用还会使用缓存对搜索进行加速，将整个搜索词对应的搜索结果直接放入缓存，以减少倒排索引的访问压力，以及不必要的集合计算。</p>
<h4>PageRank排名算法</h4>
<p>Bingoo使用PageRank算法进行网页结果排名，以保证搜索结果更符合用户期待。</p>
<p>PageRank算法会根据网页的链接关系给网页打分。如果一个网页A包含另一个网页B的超链接，那么就认为A网页给B网页投了一票。一个网页得到的投票越多，说明自己越重要；越重要的网页给自己投票，自己也越重要。</p>
<p>PageRank算法就是计算每个网页的PageRank值，最终的搜索结果也是以网页的PageRank值排序，展示给用户。事实证明，这种排名方法非常有效，PageRank值更高的网页，确实更满足用户的搜索期望。</p>
<p>以下面四个网页A、B、C、D举例，带箭头的线条表示链接。</p>
<p><img src="assets/25394ced1fc911df279e993c7b4ab7d9.jpg" alt="图片" /></p>
<p>B网页包含了A、D两个页面的超链接，相当于B网页给A、D每个页面投了一票，如果初始的时候，所有页面都是1分，那么经过这次投票后，B给了A和D每个页面1/2分（B包含了A、D两个超链接，所以每个投票值1/2分），自己从C页面得到1/3分（C包含了A、B、D三个页面的超链接，每个投票值1/3分）。</p>
<p>而A页面则从B、C、D分别得到1/2，1/3，1分。用公式表示就是</p>
<p>$\small PR（A） = \frac{PR（B）}{2}+\frac{PR（C）}{3}+\frac{PR（D）}{1}$</p>
<p>等号左边是经过一次投票后，A页面的PageRank分值；等号右边每一项的分子是包含A页面超链接的页面的PageRank分值，分母是该页面包含的超链接数目。</p>
<p>这样经过一次计算后，每个页面的PageRank分值就会重新分配，重复同样的算法过程，经过几次计算后，根据每个页面PageRank分值进行排序，就得到一个页面重要程度的排名表。根据这个排名表，将用户搜索出来的网页结果排序，排在前面的通常也正是用户期待的结果。</p>
<p>但是这个算法还有个问题，如果某个页面只包含指向自己的超链接，其他页面不断给它送分，而自己一分不出，随着计算执行次数越多，它的分值也就越高，这显然是不合理的。这种情况就像下图所示的，A页面只包含指向自己的超链接。</p>
<p><img src="assets/e1d72f3ff887d48ff6b0bc67d9a00845.jpg" alt="图片" /></p>
<p>解决方案是，设想浏览一个页面的时候，有一定概率不是点击超链接，而是在地址栏输入一个URL访问其他页面，表示在公式上，就是</p>
<p>$\small PR（A） = \alpha(\frac{PR（B）}{2}+\frac{PR（C）}{3}+\frac{PR（D）}{1})+\frac{（1-\alpha）}{4}$</p>
<p>上面$\small （1-\alpha）$就是跳转到其他任何页面的概率，通常取经验值0.15(即$\small \alpha$ 为0.85)，因为有一定概率输入的URL是自己的，所以加上上面公式最后一项，其中分母4表示所有网页的总数。</p>
<p>那么对于N个网页，任何一个页面$\small P_{i}$的PageRank计算公式如下：</p>
<p>$\small PageRank（P_{i}）=\alpha \sum_{P_{j}\in M(P_{i})}^{}{\frac{PageRank(P_{j})}{L(P_{j})}} + \frac{1-\alpha}{N}$</p>
<p>公式中，$\small P_{j}\in M(P_{i})$ 表示所有包含有$\small P_{i}$超链接的$\small P_{j}$，$\small L(P_{j})$表示$\small P_{j}$页面包含的超链接数，N表示所有的网页总和。由于Bingoo要对全世界的网页进行排名，所以这里的N是一个万亿级的数字。</p>
<p>计算开始的时候，将所有页面的PageRank值设为1，带入上面公式计算，每个页面都得到一个新的PageRank值。再把这些新的PageRank值带入上面的公式，继续得到更新的PageRank值，如此迭代计算，直到所有页面的PageRank值几乎不再有大的变化才停止。</p>
<h2>小结</h2>
<p>PageRank算法我们现在看起来平平无奇，但是正是这个算法造就了Google近2万亿美元的商业帝国。在Google之前，Yahoo已经是互联网最大的搜索引擎公司。按照一般的商业规律，如果一个创新公司不能带来十倍的效率或者体验提升，就根本没有机会挑战现有的巨头。而Google刚一出现，就给Yahoo和旧有的搜索引擎世界带来摧枯拉朽的扫荡，用户体验的提升不止十倍，这其中的秘诀正是PageRank。</p>
<p>二十几年前，我刚刚接触编程的时候，我们中国也有很多这样的编程英雄，王选、王江民、求伯君、雷军等等，他们几乎凭一己之力就创造出一个行业。正是对这些英雄们的崇拜和敬仰，引领我在编程这条路上一直走下去。软件编程是一个可以创造奇迹的地方，而不只是为了混碗饭吃。梦想不能当饭吃，但是梦想带来的可不止是一碗饭。</p>
<h2>思考题</h2>
<p>PageRank的计算，需要在万亿级的数据上进行多次迭代计算才能完成。数据量和计算量都非常大，如何完成这样的计算？也就是说，具体编程实现是怎样的？</p>
<p>欢迎在评论区分享你的思考，我们共同进步。</p>
</div>
                        </div>
                        <div>
                            <div style="float: left">
                                <a href="09%20%E4%BA%A4%E5%8F%8B%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%EF%BC%9A%E5%93%AA%E7%A7%8D%E5%9C%B0%E7%90%86%E7%A9%BA%E9%97%B4%E9%82%BB%E8%BF%91%E7%AE%97%E6%B3%95%E6%9B%B4%E5%BF%AB%EF%BC%9F.md.html">上一页</a>
                            </div>
                            <div style="float: right">
                                <a href="11%20%E5%8F%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1%EF%BC%9A%E5%A6%82%E4%BD%95%E4%BD%BF%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E6%97%A0%E9%98%BB%E5%A1%9E%E7%AD%89%E5%BE%85%EF%BC%9F.md.html">下一页</a>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="copyright"><p>© 2019 - 2023 <a href="../../cdn-cgi/l/email-protection.html#e28e8e8edbd6d3d3d2d5a2858f838b8ecc818d8f" target="_blank">Liangliang Lee</a>. Powered by <a href="https://vertx.io/" target="_blank">Vert.x</a> and <a href="https://github.com/kaiiiz/hexo-theme-book" target="_blank">hexo-theme-book</a>.</p></div>
        </div>

        <a class="off-canvas-overlay" onclick="hide_canvas()"></a>
    </div>
<script data-cfasync="false" src="../../cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/vb26e4fa9e5134444860be286fd8771851679335129114" integrity="sha512-M3hN/6cva/SjwrOtyXeUa5IuCT0sedyfT+jK/OV+s+D0RnzrTfwjwJHhd+wYfMm9HJSrZ1IKksOdddLuN6KOzw==" data-cf-beacon='{"rayId":"7af2da2f19aa965d","version":"2023.3.0","r":1,"token":"1f5d475227ce4f0089a7cff1ab17c0f5","si":100}' crossorigin="anonymous"></script>
</body>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NPSEEVD756"></script>
<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'G-NPSEEVD756');
    var path = window.location.pathname
    var cookie = getCookie("lastPath");
    console.log(path)
    if (path.replace("/", "") === "") {
        if (cookie.replace("/", "") !== "") {
            console.log(cookie)
            document.getElementById("tip").innerHTML = "<a href='" + cookie + "'>跳转到上次进度</a>"
        }
    } else {
        setCookie("lastPath", path)
    }

    function setCookie(cname, cvalue) {
        var d = new Date();
        d.setTime(d.getTime() + (180 * 24 * 60 * 60 * 1000));
        var expires = "expires=" + d.toGMTString();
        document.cookie = cname + "=" + cvalue + "; " + expires + ";path = /";
    }

    function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i].trim();
            if (c.indexOf(name) === 0) return c.substring(name.length, c.length);
        }
        return "";
    }

    hljs.initHighlightingOnLoad()

</script>

</html>
