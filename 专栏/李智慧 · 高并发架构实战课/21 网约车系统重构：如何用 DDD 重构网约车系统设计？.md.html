<!DOCTYPE html>
<!-- saved from url=(0046)https://kaiiiz.github.io/hexo-theme-book-demo/ -->
<html xmlns="http://www.w3.org/1999/xhtml">

<head>

    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
        <link rel="icon" href="../../static/favicon.png">
        <title>21 网约车系统重构：如何用 DDD 重构网约车系统设计？.md</title>
        <!-- Spectre.css framework -->
        <link rel="stylesheet" href="../../static/index.css">
        <link rel="stylesheet"
              href="../../static/highlight.min.css">
        <script src="../../static/highlight.min.js"></script>
        <!-- theme css & js -->
        <meta name="generator" content="Hexo 4.2.0">
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5295275829820252"
                crossorigin="anonymous"></script>
        <script async defer data-website-id="83e5d5db-9d06-40e3-b780-cbae722fdf8c" src="https://analyze.lianglianglee.com/umami.js"></script>
    </head>

<body>

    <div class="book-container">
        <div class="book-sidebar">
            <div class="book-brand">
                <a href="../../index.html">
                    <img src="../../static/favicon.png">
                    <span>技术文章摘抄</span>
                </a>
            </div>
            <div class="book-menu uncollapsible">
                <ul class="uncollapsible">
                    <li><a href="../../index.html" class="current-tab">首页</a></li>
                </ul>

                <ul class="uncollapsible">
                    <li><a href="../index.html">上一级</a></li>
                </ul>

                <ul class="uncollapsible">
                    <li>

                        
                        <a href="00%20%E5%BC%80%E7%AF%87%E8%AF%8D%20%E2%80%9C%E9%99%84%E8%BA%AB%E2%80%9D%E5%A4%A7%E5%8E%82%E6%9E%B6%E6%9E%84%E5%B8%88%EF%BC%8C%E8%BA%AB%E4%B8%B4%E5%85%B6%E5%A2%83%E8%AE%BE%E8%AE%A1%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F.md.html">00 开篇词 “附身”大厂架构师，身临其境设计高并发系统.md</a>

                    </li>
                    <li>

                        
                        <a href="01%20%E8%BD%AF%E4%BB%B6%E5%BB%BA%E6%A8%A1%E4%B8%8E%E6%96%87%E6%A1%A3%EF%BC%9A%E6%9E%B6%E6%9E%84%E5%B8%88%E6%80%8E%E6%A0%B7%E7%BB%98%E5%88%B6%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E8%93%9D%E5%9B%BE%EF%BC%9F.md.html">01 软件建模与文档：架构师怎样绘制系统架构蓝图？.md</a>

                    </li>
                    <li>

                        
                        <a href="02%20%E9%AB%98%E5%B9%B6%E5%8F%91%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%B3%95%EF%BC%9A%E9%9D%A2%E5%AF%B9%E9%AB%98%E5%B9%B6%E5%8F%91%EF%BC%8C%E6%80%8E%E4%B9%88%E5%AF%B9%E7%97%87%E4%B8%8B%E8%8D%AF%EF%BC%9F.md.html">02 高并发架构设计方法：面对高并发，怎么对症下药？.md</a>

                    </li>
                    <li>

                        
                        <a href="03%20%E7%9F%AD%20URL%20%E7%94%9F%E6%88%90%E5%99%A8%E8%AE%BE%E8%AE%A1%EF%BC%9A%E7%99%BE%E4%BA%BF%E7%9F%AD%20URL%20%E6%80%8E%E6%A0%B7%E5%81%9A%E5%88%B0%E6%97%A0%E5%86%B2%E7%AA%81%EF%BC%9F.md.html">03 短 URL 生成器设计：百亿短 URL 怎样做到无冲突？.md</a>

                    </li>
                    <li>

                        
                        <a href="04%20%E7%BD%91%E9%A1%B5%E7%88%AC%E8%99%AB%E8%AE%BE%E8%AE%A1%EF%BC%9A%E5%A6%82%E4%BD%95%E4%B8%8B%E8%BD%BD%E5%8D%83%E4%BA%BF%E7%BA%A7%E7%BD%91%E9%A1%B5%EF%BC%9F.md.html">04 网页爬虫设计：如何下载千亿级网页？.md</a>

                    </li>
                    <li>

                        
                        <a href="05%20%E7%BD%91%E7%9B%98%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%EF%BC%9A%E4%B8%87%E4%BA%BF%20GB%20%E7%BD%91%E7%9B%98%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%A7%92%E4%BC%A0%E4%B8%8E%E9%99%90%E9%80%9F%EF%BC%9F.md.html">05 网盘系统设计：万亿 GB 网盘如何实现秒传与限速？.md</a>

                    </li>
                    <li>

                        
                        <a href="06%20%E7%9F%AD%E8%A7%86%E9%A2%91%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%EF%BC%9A%E5%A6%82%E4%BD%95%E6%94%AF%E6%8C%81%E4%B8%89%E5%8D%83%E4%B8%87%E7%94%A8%E6%88%B7%E5%90%8C%E6%97%B6%E5%9C%A8%E7%BA%BF%E7%9C%8B%E8%A7%86%E9%A2%91%EF%BC%9F.md.html">06 短视频系统设计：如何支持三千万用户同时在线看视频？.md</a>

                    </li>
                    <li>

                        
                        <a href="07%20%E6%B5%B7%E9%87%8F%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E6%8A%80%E6%9C%AF%E5%9B%9E%E9%A1%BE%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88%E5%88%86%E5%B8%83%E5%BC%8F%E4%BC%9A%E9%81%87%E5%88%B0%20CAP%20%E9%9A%BE%E9%A2%98%EF%BC%9F.md.html">07 海量数据处理技术回顾：为什么分布式会遇到 CAP 难题？.md</a>

                    </li>
                    <li>

                        
                        <a href="08%20%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%EF%BC%9A%E4%BD%A0%E7%9A%84%E7%B3%BB%E7%BB%9F%E5%8F%AF%E4%BB%A5%E5%BA%94%E5%AF%B9%E4%B8%87%E4%BA%BA%E6%8A%A2%E8%B4%AD%E7%9B%9B%E5%86%B5%E5%90%97%EF%BC%9F.md.html">08 秒杀系统设计：你的系统可以应对万人抢购盛况吗？.md</a>

                    </li>
                    <li>

                        
                        <a href="09%20%E4%BA%A4%E5%8F%8B%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%EF%BC%9A%E5%93%AA%E7%A7%8D%E5%9C%B0%E7%90%86%E7%A9%BA%E9%97%B4%E9%82%BB%E8%BF%91%E7%AE%97%E6%B3%95%E6%9B%B4%E5%BF%AB%EF%BC%9F.md.html">09 交友系统设计：哪种地理空间邻近算法更快？.md</a>

                    </li>
                    <li>

                        
                        <a href="10%20%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E8%AE%BE%E8%AE%A1%EF%BC%9A%E4%BF%A1%E6%81%AF%E6%90%9C%E7%B4%A2%E6%80%8E%E4%B9%88%E9%81%BF%E5%85%8D%E5%A4%A7%E6%B5%B7%E6%8D%9E%E9%92%88%EF%BC%9F.md.html">10 搜索引擎设计：信息搜索怎么避免大海捞针？.md</a>

                    </li>
                    <li>

                        
                        <a href="11%20%E5%8F%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1%EF%BC%9A%E5%A6%82%E4%BD%95%E4%BD%BF%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E6%97%A0%E9%98%BB%E5%A1%9E%E7%AD%89%E5%BE%85%EF%BC%9F.md.html">11 反应式编程框架设计：如何使方法调用无阻塞等待？.md</a>

                    </li>
                    <li>

                        
                        <a href="12%20%E9%AB%98%E6%80%A7%E8%83%BD%E6%9E%B6%E6%9E%84%E7%9A%84%E4%B8%89%E6%9D%BF%E6%96%A7%EF%BC%9A%E5%88%86%E6%9E%90%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98%E4%BB%8E%E5%93%AA%E9%87%8C%E5%85%A5%E6%89%8B%EF%BC%9F.md.html">12 高性能架构的三板斧：分析系统性能问题从哪里入手？.md</a>

                    </li>
                    <li>

                        
                        <a href="13%20%E5%BE%AE%E5%8D%9A%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%EF%BC%9A%E6%80%8E%E4%B9%88%E5%BA%94%E5%AF%B9%E7%83%AD%E7%82%B9%E4%BA%8B%E4%BB%B6%E7%9A%84%E7%AA%81%E5%8F%91%E8%AE%BF%E9%97%AE%E5%8E%8B%E5%8A%9B%EF%BC%9F.md.html">13 微博系统设计：怎么应对热点事件的突发访问压力？.md</a>

                    </li>
                    <li>

                        
                        <a href="14%20%E7%99%BE%E7%A7%91%E5%BA%94%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%EF%BC%9A%E6%9C%BA%E6%88%BF%E8%A2%AB%E7%81%AB%E7%83%A7%E4%BA%86%E7%B3%BB%E7%BB%9F%E8%BF%98%E8%83%BD%E8%AE%BF%E9%97%AE%E5%90%97%EF%BC%9F.md.html">14 百科应用系统设计：机房被火烧了系统还能访问吗？.md</a>

                    </li>
                    <li>

                        
                        <a href="15%20%E9%99%90%E6%B5%81%E5%99%A8%E8%AE%BE%E8%AE%A1%EF%BC%9A%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%E8%B6%85%E9%A2%84%E6%9C%9F%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%8E%8B%E5%8A%9B%E5%8E%8B%E5%9E%AE%E7%B3%BB%E7%BB%9F%EF%BC%9F.md.html">15 限流器设计：如何避免超预期的高并发压力压垮系统？.md</a>

                    </li>
                    <li>

                        
                        <a href="16%20%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84%E7%9A%84%E5%8D%81%E7%A7%8D%E6%AD%A6%E5%99%A8%EF%BC%9A%E6%80%8E%E4%B9%88%E5%BA%A6%E9%87%8F%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%8F%AF%E7%94%A8%E6%80%A7%EF%BC%9F.md.html">16 高可用架构的十种武器：怎么度量系统的可用性？.md</a>

                    </li>
                    <li>

                        
                        <a href="17%20Web%20%E5%BA%94%E7%94%A8%E9%98%B2%E7%81%AB%E5%A2%99%EF%BC%9A%E6%80%8E%E6%A0%B7%E6%8B%A6%E6%88%AA%E6%81%B6%E6%84%8F%E7%94%A8%E6%88%B7%E7%9A%84%E9%9D%9E%E6%B3%95%E8%AF%B7%E6%B1%82%EF%BC%9F.md.html">17 Web 应用防火墙：怎样拦截恶意用户的非法请求？.md</a>

                    </li>
                    <li>

                        
                        <a href="18%20%E5%8A%A0%E8%A7%A3%E5%AF%86%E6%9C%8D%E5%8A%A1%E5%B9%B3%E5%8F%B0%EF%BC%9A%E5%A6%82%E4%BD%95%E8%AE%A9%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E4%B8%8E%E4%BC%A0%E8%BE%93%E6%9B%B4%E5%AE%89%E5%85%A8%EF%BC%9F.md.html">18 加解密服务平台：如何让敏感数据存储与传输更安全？.md</a>

                    </li>
                    <li>

                        
                        <a href="19%20%E8%AE%B8%E5%8F%AF%E5%9E%8B%E5%8C%BA%E5%9D%97%E9%93%BE%E9%87%8D%E6%9E%84%EF%BC%9A%E6%97%A0%E4%B8%AD%E5%BF%83%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E6%80%8E%E4%B9%88%E5%81%9A%E5%88%B0%E5%8F%AF%E4%BF%A1%E4%BB%BB%EF%BC%9F.md.html">19 许可型区块链重构：无中心的区块链怎么做到可信任？.md</a>

                    </li>
                    <li>

                        
                        <a href="20%20%E7%BD%91%E7%BA%A6%E8%BD%A6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%EF%BC%9A%E6%80%8E%E6%A0%B7%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E6%97%A5%E8%B5%9A%205%20%E4%BA%BF%E7%9A%84%E7%BD%91%E7%BA%A6%E8%BD%A6%E7%B3%BB%E7%BB%9F%EF%BC%9F.md.html">20 网约车系统设计：怎样设计一个日赚 5 亿的网约车系统？.md</a>

                    </li>
                    <li>

                        <a class="current-tab" href="21%20%E7%BD%91%E7%BA%A6%E8%BD%A6%E7%B3%BB%E7%BB%9F%E9%87%8D%E6%9E%84%EF%BC%9A%E5%A6%82%E4%BD%95%E7%94%A8%20DDD%20%E9%87%8D%E6%9E%84%E7%BD%91%E7%BA%A6%E8%BD%A6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%EF%BC%9F.md.html">21 网约车系统重构：如何用 DDD 重构网约车系统设计？.md</a>
                        

                    </li>
                    <li>

                        
                        <a href="22%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%B9%B3%E5%8F%B0%E8%AE%BE%E8%AE%A1%EF%BC%9A%E5%A6%82%E4%BD%95%E7%94%A8%E6%95%B0%E6%8D%AE%E4%B8%BA%E7%94%A8%E6%88%B7%E5%88%9B%E9%80%A0%E4%BB%B7%E5%80%BC%EF%BC%9F.md.html">22 大数据平台设计：如何用数据为用户创造价值？.md</a>

                    </li>
                    <li>

                        
                        <a href="%E7%BB%93%E6%9D%9F%E8%AF%AD%20%E4%B8%80%E4%B8%AA%E6%9E%B6%E6%9E%84%E5%B8%88%E7%9A%84%E4%B8%80%E5%A4%A9.md.html">结束语 一个架构师的一天.md</a>

                    </li>
                </ul>

            </div>
        </div>

        <div class="sidebar-toggle" onclick="sidebar_toggle()" onmouseover="add_inner()" onmouseleave="remove_inner()">
            <div class="sidebar-toggle-inner"></div>
        </div>

        <script>
            function add_inner() {
                let inner = document.querySelector('.sidebar-toggle-inner')
                inner.classList.add('show')
            }

            function remove_inner() {
                let inner = document.querySelector('.sidebar-toggle-inner')
                inner.classList.remove('show')
            }

            function sidebar_toggle() {
                let sidebar_toggle = document.querySelector('.sidebar-toggle')
                let sidebar = document.querySelector('.book-sidebar')
                let content = document.querySelector('.off-canvas-content')
                if (sidebar_toggle.classList.contains('extend')) { // show
                    sidebar_toggle.classList.remove('extend')
                    sidebar.classList.remove('hide')
                    content.classList.remove('extend')
                } else { // hide
                    sidebar_toggle.classList.add('extend')
                    sidebar.classList.add('hide')
                    content.classList.add('extend')
                }
            }


            function open_sidebar() {
                let sidebar = document.querySelector('.book-sidebar')
                let overlay = document.querySelector('.off-canvas-overlay')
                sidebar.classList.add('show')
                overlay.classList.add('show')
            }
            function hide_canvas() {
                let sidebar = document.querySelector('.book-sidebar')
                let overlay = document.querySelector('.off-canvas-overlay')
                sidebar.classList.remove('show')
                overlay.classList.remove('show')
            }

        </script>

        <div class="off-canvas-content">
            <div class="columns">
                <div class="column col-12 col-lg-12">
                    <div class="book-navbar">
                        <!-- For Responsive Layout -->
                        <header class="navbar">
                            <section class="navbar-section">
                                <a onclick="open_sidebar()">
                                    <i class="icon icon-menu"></i>
                                </a>
                            </section>
                        </header>
                    </div>
                    <div class="book-content" style="max-width: 960px; margin: 0 auto;
    overflow-x: auto;
    overflow-y: hidden;">
                        <div class="book-post">
                            <p id="tip" align="center"></p>
                            <div><h1>21 网约车系统重构：如何用 DDD 重构网约车系统设计？</h1>
<p>你好，我是李智慧。</p>
<p>软件开发是一个过程，这个过程中相关方对软件系统的认知会不断改变。当系统现状和大家的认知有严重冲突的时候，不重构系统就难以继续开发下去。此外，在持续的需求迭代过程中，代码本身会逐渐腐坏，变得僵硬、脆弱、难以维护，需求开发周期越来越长，bug却越来越多，系统也必须要进行重构。</p>
<p>我们在前一篇讨论的Udi网约车系统经过了几年的快速发展，随着业务越来越复杂，功能模块越来越多，开发团队越来越庞大，整个系统也越来越笨拙、难以维护。以前两三天就能开发完成的新功能，现在要几个星期，开发人员多了，工作效率却下降了。</p>
<p>Udi使用微服务架构，开始的时候业务比较简单，几个微服务就可以搞定。后面随着功能越来越多，微服务也越来越多，微服务之间的依赖关系也变得越来越复杂，常常要开发一个小功能，却需要在好几个微服务中进行修改。后来开发人员为了避免这种复杂性，倾向于把所有功能都写在一个微服务里，结果整个系统架构又开始退回到单体架构。</p>
<p>基于以上原因，我们准备对Udi进行一次重构，核心就是要解决微服务设计的混乱，梳理、重构出更加清晰的微服务边界和微服务之间的依赖关系。我们准备使用DDD，即领域驱动设计的方法进行这次重构。</p>
<p>那么，领域驱动设计的核心思想是什么？设计的一般方法是什么？如何将这些方法应用到Udi的重构过程中？这些就是我们今天要解决的主要问题。</p>
<h2>DDD的一般方法</h2>
<p>领域是一个组织所做的事情以及其包含的一切，通俗地说，就是组织的业务范围和做事方式，也是软件开发的目标范围。比如对于淘宝这样一个以电子商务为主要业务的组织，C2C电子商务就是它的领域。<strong>领域驱动设计就是从领域出发，分析领域内模型及其关系，进而设计软件系统的方法。</strong></p>
<p>但是如果我们说要对C2C电子商务这个领域进行建模设计，那么这个范围就太大了，不知道该如何下手。所以通常的做法是把整个领域拆分成多个<strong>子域</strong>，比如用户、商品、订单、库存、物流、发票等。强相关的多个子域组成一个<strong>限界上下文</strong>，它是对业务领域范围的描述，对于系统实现而言，限界上下文相当于是一个子系统或者一个模块。限界上下文和子域共同组成组织的领域，如下：</p>
<p><img src="assets/297fa4e7e64e9fcdf91e600f28d56cfb.jpg" alt="图片" /></p>
<p>不同的限界上下文，也就是不同的子系统或者模块之间会有各种的交互合作。如何设计这些交互合作呢？DDD使用<strong>上下文映射图</strong>来完成，如下：</p>
<p><img src="assets/b661e8bfabe968794ae80d01b81f73a6.jpg" alt="图片" /></p>
<p>在DDD中，领域模型对象也被称为<strong>实体</strong>。先通过业务分析，识别出实体对象，然后通过相关的业务逻辑，设计实体的属性和方法。而限界上下文和上下文映射图则是微服务设计的关键，通常在实践中，限界上下文被设计为微服务，而上下文映射图就是微服务之间的依赖关系。具体设计过程如下图：</p>
<p><img src="assets/cc4aac65f24bfcfd2f965973070f3331.jpg" alt="图片" /></p>
<p>首先，领域专家和团队一起讨论分析业务领域，确认业务期望，将业务分解成若干个业务场景。然后，针对每个场景画UML活动图，活动图中包含泳道，通过高内聚原则对功能逻辑不断调整，使功能和泳道之间的归属关系变得更加清晰合理。<strong>这些泳道最终就是限界上下文，泳道内的功能就是将来微服务的功能边界，泳道之间的调用流程关系，就是将来微服务之间的依赖关系，即上下文映射图。</strong></p>
<p>但是，这个状态的泳道还不能直接转化成限界上下文。有些限界上下文可能会很大，有些依赖关系可能会比较强。而一个限界上下文不应该超过一个团队的职责范围，因为根据康威定律：组织<strong>架构决定系统架构</strong>，两个团队维护一个微服务，必然会将这个微服务搞成事实上的两个微服务。所以，我们还需要根据团队特性、过往的工作职责、技能经验，重新对泳道图进行调整，使其符合团队的职责划分，这时候才得到限界上下文。</p>
<p>在这个限界上下文基础上，考虑技术框架、非功能需求、服务重用性等因素，进一步进行调整，就得到最终的限界上下文设计，形成我们的微服务架构设计。</p>
<p>我们将遵循上述DDD方法过程对Udi微服务进行重新分析设计，并进行系统重构。</p>
<h2>Udi DDD 重构设计</h2>
<p>首先分析我们的业务领域，通过头脑/事件风暴的形式，收集领域内的所有事件/命令，并识别事件/命令的发起方即对应的实体。最后识别出来的实体以及相关活动如下表：</p>
<p><img src="assets/09e53a303016b07a49da69aec0145729.jpg" alt="图片" /></p>
<p>基于核心实体模型，绘制实体关系图，如下：</p>
<p><img src="assets/4fc8ebe70deae09e043194b27e15ed81.png" alt="图片" /></p>
<p>在实体间关系明确且完整的前提下，我们就可以针对各个业务场景，绘制场景活动图。活动图比较多，这里仅用拼车场景作为示例，如下：</p>
<p><img src="assets/8611bb0513340f6a0a46946ba34a8f1b.png" alt="图片" /></p>
<p>依据各种重要场景的活动图，参考团队职责范围，结合微服务重用性考虑及非功能需求，产生限界上下文如下表：</p>
<p><img src="assets/597f2ccf6576d1acc4868600b66eea93.jpg" alt="图片" /></p>
<p>针对每个限界上下文进一步设计其内部的聚合、聚合根、实体、值对象、功能边界。以订单限界上下文为例：</p>
<p><img src="assets/99452cc01307c21866a662ae1fe37ce9.jpg" alt="图片" /></p>
<p>上述订单实体的属性和功能如下表：</p>
<p><img src="assets/ecd11ebbec719a3b1beed7d7f8103029.jpg" alt="图片" /></p>
<p>最后，在实现层面，设计对应的微服务架构如下图：</p>
<p><img src="assets/e3efb97e6376f10774d99dd8d5cd8b41.png" alt="图片" /></p>
<p>这是一个基于领域模型的分层架构，最下层为聚合根对象，组合实体与值对象，完成核心业务逻辑处理。上面一层为领域服务层，主要调用聚合根对象完成订单子域的业务，根据业务情况，也会在这一层和其他微服务通信，完成更复杂的、超出当前实体职责的业务，所以这一层也是一个聚合层。</p>
<p>再上面一层是应用服务层，将实体的功能封装成各种服务，供各种应用场景调用。而最上面是一个接口层，提供微服务调用接口。</p>
<h2>小结</h2>
<p>领域驱动设计很多时候雷声大，雨点小，说起来各种术语满天飞，真正开发实践的时候又无从下手。这节的案例来自一个真实落地的DDD重构设计文档，你可以参考这个文档，按图索骥，应用到自己的开发实践中。</p>
<p>既然说到“按图索骥”，那我认为也有必要在这一节的最后，帮你画一个更有概括性的DDD重构路线图，我们把使用DDD进行系统重构的过程分为以下六步：</p>
<ol>
<li>讨论当前系统存在的问题，发现问题背后的根源。比如：架构与代码混乱，需求迭代困难，部署麻烦，bug率逐渐升高；微服务边界不清晰，调用依赖关系复杂，团队职责混乱。</li>
<li>针对问题分析具体原因。比如：微服务 A 太庞大，微服务B和C职责不清，团队内业务理解不一致，内部代码设计不良，硬编码和耦合太多。</li>
<li>重新梳理业务流程，明确业务术语，进行DDD战略设计，具体又可以分为三步。-
a. 进行头脑风暴，分析业务现状和期望，构建领域语言；-
b. 画泳道活动图、结合团队特性设计限界上下文；-
c. 根据架构方案和非功能需求确定微服务设计。</li>
<li>针对当前系统实现和DDD设计不匹配的地方，设计微服务重构方案。比如：哪些微服务需要重新开发，哪些微服务的功能需要从A调整到B，哪些微服务需要分拆。</li>
<li>DDD技术验证。针对比较重要、问题比较多的微服务进行重构打样，设计聚合根、实体、值对象，重构关键代码，验证设计是否合理以及团队能否驾驭DDD。</li>
<li>任务分解与持续重构。在尽量不影响业务迭代的前提下，按照重构方案，将重构开发和业务迭代有机融合。</li>
</ol>
<h2>思考题</h2>
<p>你认为DDD最大的价值是什么？如何才能成功落地DDD？</p>
</div>
                        </div>
                        <div>
                            <div style="float: left">
                                <a href="20%20%E7%BD%91%E7%BA%A6%E8%BD%A6%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%EF%BC%9A%E6%80%8E%E6%A0%B7%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E6%97%A5%E8%B5%9A%205%20%E4%BA%BF%E7%9A%84%E7%BD%91%E7%BA%A6%E8%BD%A6%E7%B3%BB%E7%BB%9F%EF%BC%9F.md.html">上一页</a>
                            </div>
                            <div style="float: right">
                                <a href="22%20%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%B9%B3%E5%8F%B0%E8%AE%BE%E8%AE%A1%EF%BC%9A%E5%A6%82%E4%BD%95%E7%94%A8%E6%95%B0%E6%8D%AE%E4%B8%BA%E7%94%A8%E6%88%B7%E5%88%9B%E9%80%A0%E4%BB%B7%E5%80%BC%EF%BC%9F.md.html">下一页</a>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="copyright"><p>© 2019 - 2023 <a href="../../cdn-cgi/l/email-protection.html#355959590c0104040502755258545c591b565a58" target="_blank">Liangliang Lee</a>. Powered by <a href="https://vertx.io/" target="_blank">Vert.x</a> and <a href="https://github.com/kaiiiz/hexo-theme-book" target="_blank">hexo-theme-book</a>.</p></div>
        </div>

        <a class="off-canvas-overlay" onclick="hide_canvas()"></a>
    </div>
<script data-cfasync="false" src="../../cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/vb26e4fa9e5134444860be286fd8771851679335129114" integrity="sha512-M3hN/6cva/SjwrOtyXeUa5IuCT0sedyfT+jK/OV+s+D0RnzrTfwjwJHhd+wYfMm9HJSrZ1IKksOdddLuN6KOzw==" data-cf-beacon='{"rayId":"7af2e0717d03965d","version":"2023.3.0","r":1,"token":"1f5d475227ce4f0089a7cff1ab17c0f5","si":100}' crossorigin="anonymous"></script>
</body>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NPSEEVD756"></script>
<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'G-NPSEEVD756');
    var path = window.location.pathname
    var cookie = getCookie("lastPath");
    console.log(path)
    if (path.replace("/", "") === "") {
        if (cookie.replace("/", "") !== "") {
            console.log(cookie)
            document.getElementById("tip").innerHTML = "<a href='" + cookie + "'>跳转到上次进度</a>"
        }
    } else {
        setCookie("lastPath", path)
    }

    function setCookie(cname, cvalue) {
        var d = new Date();
        d.setTime(d.getTime() + (180 * 24 * 60 * 60 * 1000));
        var expires = "expires=" + d.toGMTString();
        document.cookie = cname + "=" + cvalue + "; " + expires + ";path = /";
    }

    function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i].trim();
            if (c.indexOf(name) === 0) return c.substring(name.length, c.length);
        }
        return "";
    }

    hljs.initHighlightingOnLoad()

</script>

</html>
