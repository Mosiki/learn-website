<!DOCTYPE html>
<!-- saved from url=(0046)https://kaiiiz.github.io/hexo-theme-book-demo/ -->
<html xmlns="http://www.w3.org/1999/xhtml">

<head>

    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
        <link rel="icon" href="../../static/favicon.png">
        <title>17 运维：如何运维日均亿级的消息集群？.md</title>
        <!-- Spectre.css framework -->
        <link rel="stylesheet" href="../../static/index.css">
        <link rel="stylesheet"
              href="../../static/highlight.min.css">
        <script src="../../static/highlight.min.js"></script>
        <!-- theme css & js -->
        <meta name="generator" content="Hexo 4.2.0">
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5295275829820252"
                crossorigin="anonymous"></script>
        <script async defer data-website-id="83e5d5db-9d06-40e3-b780-cbae722fdf8c" src="https://analyze.lianglianglee.com/umami.js"></script>
    </head>

<body>

    <div class="book-container">
        <div class="book-sidebar">
            <div class="book-brand">
                <a href="../../index.html">
                    <img src="../../static/favicon.png">
                    <span>技术文章摘抄</span>
                </a>
            </div>
            <div class="book-menu uncollapsible">
                <ul class="uncollapsible">
                    <li><a href="../../index.html" class="current-tab">首页</a></li>
                </ul>

                <ul class="uncollapsible">
                    <li><a href="../index.html">上一级</a></li>
                </ul>

                <ul class="uncollapsible">
                    <li>

                        
                        <a href="00%20%E5%BC%80%E7%AF%87%E8%AF%8D%20%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AF%B9%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84%E4%BD%93%E7%B3%BB%E6%9D%A5%E8%AF%B4%E8%BF%99%E4%B9%88%E9%87%8D%E8%A6%81%EF%BC%9F.md.html">00 开篇词 为什么中间件对分布式架构体系来说这么重要？.md</a>

                    </li>
                    <li>

                        
                        <a href="01%20%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%94%9F%E6%80%81%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9A%E6%9C%89%E5%93%AA%E4%BA%9B%E7%B1%BB%E5%9E%8B%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%9F.md.html">01 中间件生态（上）：有哪些类型的中间件？.md</a>

                    </li>
                    <li>

                        
                        <a href="02%20%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%94%9F%E6%80%81%EF%BC%88%E4%B8%8B%EF%BC%89%EF%BC%9A%E5%90%8C%E7%B1%BB%E5%9E%8B%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E9%80%89%E5%9E%8B%EF%BC%9F.md.html">02 中间件生态（下）：同类型的中间件如何进行选型？.md</a>

                    </li>
                    <li>

                        
                        <a href="03%20%20%E6%95%B0%E7%BB%84%E4%B8%8E%E9%93%BE%E8%A1%A8%EF%BC%9A%E5%AD%98%E5%82%A8%E8%AE%BE%E8%AE%A1%E7%9A%84%E5%9F%BA%E7%9F%B3%E6%9C%89%E5%93%AA%E4%BA%9B%EF%BC%9F.md.html">03  数组与链表：存储设计的基石有哪些？.md</a>

                    </li>
                    <li>

                        
                        <a href="04%20%20%E7%BA%A2%E9%BB%91%E6%A0%91%EF%BC%9A%E5%9B%BE%E8%A7%A3%E7%BA%A2%E9%BB%91%E6%A0%91%E7%9A%84%E6%9E%84%E9%80%A0%E8%BF%87%E7%A8%8B%E4%B8%8E%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF.md.html">04  红黑树：图解红黑树的构造过程与应用场景.md</a>

                    </li>
                    <li>

                        
                        <a href="05%20%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%EF%BC%9A%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B%E6%9C%89%E5%93%AA%E4%BA%9B%E5%B8%B8%E8%A7%81%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%EF%BC%9F.md.html">05  多线程：多线程编程有哪些常见的设计模式？.md</a>

                    </li>
                    <li>

                        
                        <a href="06%20%20%E9%94%81%EF%BC%9A%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E9%94%81%E7%9A%84%E5%90%8C%E6%AD%A5%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97%E4%B8%8E%E6%9D%A1%E4%BB%B6%E9%98%9F%E5%88%97%EF%BC%9F.md.html">06  锁：如何理解锁的同步阻塞队列与条件队列？.md</a>

                    </li>
                    <li>

                        
                        <a href="07%20%20NIO%EF%BC%9A%E6%89%8B%E6%92%B8%E4%B8%80%E4%B8%AA%E7%AE%80%E6%98%93%E7%9A%84%E4%B8%BB%E4%BB%8E%E5%A4%9AReactor%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B.md.html">07  NIO：手撸一个简易的主从多Reactor线程模型.md</a>

                    </li>
                    <li>

                        
                        <a href="08%20%20Netty%EF%BC%9A%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E5%9C%B0%E5%A4%84%E7%90%86%E7%BD%91%E7%BB%9C%E8%AF%BB%E5%86%99%EF%BC%8C%E5%88%B6%E5%AE%9A%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE%EF%BC%9F.md.html">08  Netty：如何优雅地处理网络读写，制定网络通信协议？.md</a>

                    </li>
                    <li>

                        
                        <a href="08%20%E5%8A%A0%E9%A4%90%20%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%BA%95%E5%B1%82%E7%9A%84%E9%80%9A%E7%94%A8%E8%AE%BE%E8%AE%A1%E7%90%86%E5%BF%B5.md.html">08 加餐 中间件底层的通用设计理念.md</a>

                    </li>
                    <li>

                        
                        <a href="09%20%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B%EF%BC%9A%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%EF%BC%9F.md.html">09 技术选型：如何选择微服务框架和注册中心？.md</a>

                    </li>
                    <li>

                        
                        <a href="10%20%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86%EF%BC%9ADubbo%E6%A0%B8%E5%BF%83%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90.md.html">10 设计原理：Dubbo核心设计原理剖析.md</a>

                    </li>
                    <li>

                        
                        <a href="11%20%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8EDubbo%E8%BF%9B%E8%A1%8C%E7%BD%91%E5%85%B3%E8%AE%BE%E8%AE%A1%EF%BC%9F.md.html">11 案例：如何基于Dubbo进行网关设计？.md</a>

                    </li>
                    <li>

                        
                        <a href="12%20%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%93%9D%E7%BB%BF%E5%8F%91%E5%B8%83%EF%BC%9F.md.html">12 案例：如何实现蓝绿发布？.md</a>

                    </li>
                    <li>

                        
                        <a href="13%20%20%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B%EF%BC%9A%E5%A6%82%E4%BD%95%E6%A0%B9%E6%8D%AE%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%E9%80%89%E6%8B%A9%E5%90%88%E9%80%82%E7%9A%84%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%9F.md.html">13  技术选型：如何根据应用场景选择合适的消息中间件？.md</a>

                    </li>
                    <li>

                        
                        <a href="14%20%20%E6%80%A7%E8%83%BD%E4%B9%8B%E9%81%93%EF%BC%9ARocketMQ%E4%B8%8EKafka%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%BE%E8%AE%A1%E5%AF%B9%E6%AF%94.md.html">14  性能之道：RocketMQ与Kafka高性能设计对比.md</a>

                    </li>
                    <li>

                        
                        <a href="15%20%E6%A1%88%E4%BE%8B%EF%BC%9A%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%93%9D%E7%BB%BF%EF%BC%9F.md.html">15 案例：消息中间件如何实现蓝绿？.md</a>

                    </li>
                    <li>

                        
                        <a href="16%20%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%A6%82%E4%BD%95%E6%8F%90%E5%8D%87RocketMQ%E9%A1%BA%E5%BA%8F%E6%B6%88%E8%B4%B9%E6%80%A7%E8%83%BD%EF%BC%9F.md.html">16 案例：如何提升RocketMQ顺序消费性能？.md</a>

                    </li>
                    <li>

                        <a class="current-tab" href="17%20%E8%BF%90%E7%BB%B4%EF%BC%9A%E5%A6%82%E4%BD%95%E8%BF%90%E7%BB%B4%E6%97%A5%E5%9D%87%E4%BA%BF%E7%BA%A7%E7%9A%84%E6%B6%88%E6%81%AF%E9%9B%86%E7%BE%A4%EF%BC%9F.md.html">17 运维：如何运维日均亿级的消息集群？.md</a>
                        

                    </li>
                    <li>

                        
                        <a href="18%20%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%A6%82%E4%BD%95%E6%8E%92%E6%9F%A5RocketMQ%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E8%B6%85%E6%97%B6%E6%95%85%E9%9A%9C%EF%BC%9F.md.html">18 案例：如何排查RocketMQ消息发送超时故障？.md</a>

                    </li>
                    <li>

                        
                        <a href="19%20%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%A6%82%E4%BD%95%E6%8E%92%E6%9F%A5RocketMQ%E6%B6%88%E6%81%AF%E6%B6%88%E8%B4%B9%E7%A7%AF%E5%8E%8B%E9%97%AE%E9%A2%98%EF%BC%9F.md.html">19 案例：如何排查RocketMQ消息消费积压问题？.md</a>

                    </li>
                    <li>

                        
                        <a href="20%20%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B%EF%BC%9A%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6%E7%9A%84%E5%8A%9F%E8%83%BD%E5%92%8C%E6%9C%AA%E6%9D%A5.md.html">20 技术选型：分布式定时调度框架的功能和未来.md</a>

                    </li>
                    <li>

                        
                        <a href="21%20%E8%AE%BE%E8%AE%A1%E7%90%86%E5%BF%B5%EF%BC%9A%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8EZooKeeper%E8%AE%BE%E8%AE%A1%E5%87%86%E5%AE%9E%E6%97%B6%E6%9E%B6%E6%9E%84%EF%BC%9F.md.html">21 设计理念：如何基于ZooKeeper设计准实时架构？.md</a>

                    </li>
                    <li>

                        
                        <a href="22%20%E6%A1%88%E4%BE%8B%EF%BC%9A%E4%BD%BF%E7%94%A8%E5%88%86%E5%B8%83%E5%BC%8F%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6%E8%AF%A5%E8%80%83%E8%99%91%E5%93%AA%E4%BA%9B%E9%97%AE%E9%A2%98%EF%BC%9F.md.html">22 案例：使用分布式调度框架该考虑哪些问题？.md</a>

                    </li>
                    <li>

                        
                        <a href="23%20%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%A6%82%E4%BD%95%E5%9C%A8%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E8%BF%9B%E8%A1%8C%E5%85%A8%E9%93%BE%E8%B7%AF%E5%8E%8B%E6%B5%8B%EF%BC%9F.md.html">23 案例：如何在生产环境进行全链路压测？.md</a>

                    </li>
                    <li>

                        
                        <a href="%E5%A4%A7%E5%92%96%E5%8A%A9%E9%98%B5%20%20%E9%AB%98%E6%A5%BC%EF%BC%9A%E6%88%91%E4%BB%AC%E5%BA%94%E8%AF%A5%E5%A6%82%E4%BD%95%E5%AD%A6%E4%B9%A0%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%9F.md.html">大咖助阵  高楼：我们应该如何学习中间件？.md</a>

                    </li>
                    <li>

                        
                        <a href="%E7%94%A8%E6%88%B7%E6%95%85%E4%BA%8B%20%20%E5%AD%A6%E8%80%8C%E6%97%B6%E4%B9%A0%E4%B9%8B%EF%BC%8C%E4%B8%8D%E4%BA%A6%E4%B9%90%E4%B9%8E.md.html">用户故事  学而时习之，不亦乐乎.md</a>

                    </li>
                    <li>

                        
                        <a href="%E7%94%A8%E6%88%B7%E6%95%85%E4%BA%8B%20%20%E6%84%BF%E5%81%9A%E6%8A%80%E6%9C%AF%E7%9A%84%E8%BF%BD%E6%A2%A6%E4%BA%BA.md.html">用户故事  愿做技术的追梦人.md</a>

                    </li>
                    <li>

                        
                        <a href="%E7%94%A8%E6%88%B7%E6%95%85%E4%BA%8B%20%20%E6%B5%AA%E8%B4%B9%E6%97%B6%E9%97%B4%E4%B9%9F%E6%98%AF%E4%B8%BA%E4%BA%86%E7%8F%8D%E6%83%9C%E6%97%B6%E9%97%B4.md.html">用户故事  浪费时间也是为了珍惜时间.md</a>

                    </li>
                    <li>

                        
                        <a href="%E7%BB%93%E6%9D%9F%E8%AF%AD%20%E5%9D%9A%E6%8C%81%E4%B8%8D%E6%87%88%EF%BC%8C%E8%B6%8A%E5%8A%AA%E5%8A%9B%E8%B6%8A%E5%B9%B8%E8%BF%90.md.html">结束语 坚持不懈，越努力越幸运.md</a>

                    </li>
                </ul>

            </div>
        </div>

        <div class="sidebar-toggle" onclick="sidebar_toggle()" onmouseover="add_inner()" onmouseleave="remove_inner()">
            <div class="sidebar-toggle-inner"></div>
        </div>

        <script>
            function add_inner() {
                let inner = document.querySelector('.sidebar-toggle-inner')
                inner.classList.add('show')
            }

            function remove_inner() {
                let inner = document.querySelector('.sidebar-toggle-inner')
                inner.classList.remove('show')
            }

            function sidebar_toggle() {
                let sidebar_toggle = document.querySelector('.sidebar-toggle')
                let sidebar = document.querySelector('.book-sidebar')
                let content = document.querySelector('.off-canvas-content')
                if (sidebar_toggle.classList.contains('extend')) { // show
                    sidebar_toggle.classList.remove('extend')
                    sidebar.classList.remove('hide')
                    content.classList.remove('extend')
                } else { // hide
                    sidebar_toggle.classList.add('extend')
                    sidebar.classList.add('hide')
                    content.classList.add('extend')
                }
            }


            function open_sidebar() {
                let sidebar = document.querySelector('.book-sidebar')
                let overlay = document.querySelector('.off-canvas-overlay')
                sidebar.classList.add('show')
                overlay.classList.add('show')
            }
            function hide_canvas() {
                let sidebar = document.querySelector('.book-sidebar')
                let overlay = document.querySelector('.off-canvas-overlay')
                sidebar.classList.remove('show')
                overlay.classList.remove('show')
            }

        </script>

        <div class="off-canvas-content">
            <div class="columns">
                <div class="column col-12 col-lg-12">
                    <div class="book-navbar">
                        <!-- For Responsive Layout -->
                        <header class="navbar">
                            <section class="navbar-section">
                                <a onclick="open_sidebar()">
                                    <i class="icon icon-menu"></i>
                                </a>
                            </section>
                        </header>
                    </div>
                    <div class="book-content" style="max-width: 960px; margin: 0 auto;
    overflow-x: auto;
    overflow-y: hidden;">
                        <div class="book-post">
                            <p id="tip" align="center"></p>
                            <div><h1>17 运维：如何运维日均亿级的消息集群？</h1>
<p>你好，我是丁威。</p>
<p>得益于我所处的平台，依托快递行业巨大的业务流量，我所在的公司的日均消息流转量（消息发送、消息消费）已经达到万亿级别，消息中间件在公司的使用也非常广泛。这节课，我会结合自己的实践经验和你一起来看看如何在生产环境中运维消息集群。</p>
<h2>集群部署</h2>
<p>尽管消息集群都可以灵活地扩缩容，但我们在运维集群时还是不应该搭建太大的集群。因为一旦集群受影响，影响范围会很大。合理规划消息集群尤为重要，结合我的集群规划实践，我提炼出了下面几条经验供你参考。</p>
<ul>
<li>业务场景</li>
</ul>
<p>核心业务要按业务域进行规划，并且通常采用 RocketMQ。例如我们可以划分出订单、运单、财金等业务域。业务域内尽量独占。</p>
<p>日志采集类通常采用 Kafka，并且也要搭建几套日志集群，做好拆分，控制好影响的范围。</p>
<ul>
<li>应用特点</li>
</ul>
<p>消息集群的客户端通常使用长连接。但大数据领域很多数据抽取都是批处理任务，而批处理任务使用的是短连接，所以大数据领域这种我们会规划到单独的集群；另外在定时消息、大消息等场景下，也要规划专属集群。</p>
<p>规划了这么多的集群，集群的管理就成了难点。我们专门开发一个消息运维平台 ZMS，它支持在线安装 RocketMQ、Kafka、ZooKeeper 等中间件，安装原理如下：</p>
<p><img src="assets/e4aebb2739826fb56fae7975b6395a56-20220924201041-4t8crdb.jpg" alt="" /></p>
<p>我们对集群部署设计原理中的关键角色一一做个说明。</p>
<ul>
<li>service instance</li>
</ul>
<p>服务实例，它是服务中的一个节点。在同一时刻，一个服务实例只能有一个正在主机中运行的进程。一个服务可能包含多个服务实例。</p>
<ul>
<li>zms-agent</li>
</ul>
<p>zms-agent（ZMS 代理）是 zms-portal 与主机中的服务实例进行交互的桥梁。它可以实现服务实例的启动、停止和重启操作，还能够监控服务实例进程状态。</p>
<ul>
<li>supervisor</li>
</ul>
<p>zms-agent 通过 supervisor 对主机上的进程进行管理，可实现进程状态监控、异常退出、重启等功能。</p>
<p>顺便说一句，ZMS 是通过在主机上安装代理，来实现对主机上服务的控制的，这种控制包括服务启动、停止、重启等操作。同时，我们还可以通过 agent 把服务进程和主机状态上报到 zms-portal，实现对主机和服务进程的监控。</p>
<p>ZMS 目前已开源，可以点击“<a href="https://github.com/ZTO-Express/zmss">开源地址</a>”下载。</p>
<h2>集群扩容</h2>
<p>从运维角度解决了集群的安装部署问题，接下来我们来看看在生产环境中，一般是怎么运维消息中间件的。</p>
<p><strong>中间件的运维必须遵循一个最基本的原则：中间件所做的变更要对业务无感知。即，中间件做的任何变更不需要业务方配合，也不会影响正在运行的业务，当然为了安全起见，还是需要将变更操作通知业务方，做一些必要的检查工作。</strong></p>
<p>我们先来看如何优雅地对集群进行扩容。</p>
<p>“双十一”、618 等大促活动时，各快递公司的业务量往往是平时的几倍。所以，在大促来临之前，我们都会对现有系统进行压测，评估容量，压测后通常会采取扩容等手段以扛住大促前后的巨大流量。那怎么对消息集群进行扩容呢？</p>
<p>我们分别讨论 RocketMQ、Kafka 这两种中间件。</p>
<p>先说 RocketMQ。例如现在已经有一个两主的集群了，部署如下图所示：</p>
<p><img src="assets/74417369a636e606e34d2eea7acbf092-20220924201044-eb64737.jpg" alt="" /></p>
<p>现在需要扩容到 3 个主节点，我们首先要在新添加的机器 192.168.3.106 上也安装一个 Broker，命名为 broker-c。扩容后的部署图为：</p>
<p><img src="assets/405198f8870ba415938745ec3c152e22-20220924201044-9iuqybt.jpg" alt="" /></p>
<p>这样就把 broker-c 扩容到集群了。但这个时候你会发现，新增加的 Broker 并没有任何流量，这是因为 broker-c 上目前没有创建任何主题，自然就没有消息写入。</p>
<p>为了快速让 broker-c 上拥有集群内其他节点中的主题定义，我们通常可以拷贝集群内其他节点的主题定义文件，具体要复制的文件路径为：{ROCKETMQ_HOME}/store/config/topics.json 文件。其中，ROCKETMQ_HOME 表示集群的主目录，具体的文件存储如下图所示：</p>
<p><img src="assets/a2ae7c93aa638eda8e5ca91cc6a1ce8a-20220924201044-qjkdkdg.png" alt="" /></p>
<p>如果 Broker 关闭了自动创建消费组（autoCreateSubscriptionGroup=false），还需要拷贝 subscriptionGroup.json 文件。</p>
<p>这样，再次重启新加入的机器，就可以承担读写流量，实现负载均衡了。</p>
<p>我们再来说一下 Kafka 中集群节点的扩容。</p>
<p>第一步和 RocketMQ 一样，也就是在新节点上安装一个 Kafka，并与原先节点使用相同的 ZooKeeper 集群。这时，节点会扩容到集群中，但是与 RocketMQ 相同，这个节点暂时也不会有任何流量进来。那要如何使新节点承担数据的读写呢？</p>
<p><strong>我们需要进行分区重分配，手动将部分主题的分区分配到新的节点。</strong></p>
<p>在介绍具体的分配方式之前，我们先来看一下 dw_test_topic_0709003 的分区分布情况：</p>
<p><img src="assets/e57251a83f8eaca90078f13c0bf8f027-20220924201044-h7ukpf7.png" alt="" /></p>
<p>你可以重点关注一下 Leader 这一项，它表示分区所在的 Broker 节点。</p>
<p>好了，下面我们具体来看一下怎么对分区进行重分配。这里总共有三个步骤。</p>
<p>**第一步：**挑选出一部分重要主题，或者是当前 TPS 排名靠前的主题，整理成 JSON 文件。</p>
<pre><code>{&quot;topics&quot;:
    [
        {&quot;topic&quot;:&quot;dw_test_topic_0709003&quot;}
    ],
    &quot;version&quot;: 1
}
</code></pre>
<p>**第二步：**使用 Kafka 提供的 kafka-reassign-partitions.sh 命令生成执行计划。具体命令如下：</p>
<pre><code class="language-bash">./kafka-reassign-partitions.sh --bootstrap-server 127.0.0.1:9092 --topics-to-move-json-file ./tmp/dw_test_topic_0709003-topics-to-move.json --broker-list &quot;0,1,2,4&quot; --generate --zookeeper 127.0.0.1:2181
</code></pre>
<p>该命令运行后的截图如下：</p>
<p><img src="assets/98f4aa8e177e038d8b80fc736fd0e45f-20220924201044-3ue07mg.png" alt="" /></p>
<p>执行命令后会输出下面两部分内容。</p>
<ul>
<li>
<p>Current partition replica assignment：表示主题分区迁移之前的结果，通常把这部分内容保存在一个文件中，用于回滚操作。</p>
</li>
<li>
<p>Proposed partition reassignment configuration：分区重新分配后的执行计划。</p>
</li>
</ul>
<p>**第三步：**把上一步生成的执行计划存储到一个 JSON 文件中，然后执行如下命令：</p>
<pre><code class="language-bash">./kafka-reassign-partitions.sh --bootstrap-server 127.0.0.1:9092 --reassignment-json-file  ./tmp/dw_test_topic_0709003-reassignment-json-file.json  --execute --zookeeper 127.0.0.1:2181/kafka_cluster_01
</code></pre>
<p>该命令的执行结果如下图所示：</p>
<p><img src="assets/cb8a51322471824c0c83c0ecdf51764d-20220924201045-g6ndwhl.png" alt="" /></p>
<p>响应结果还会返回迁移之前的分区情况，可用作回滚操作。值得注意的是，这个操作只会触发分区重分配，不会影响客户端的写入和读取。但如果分区的数据比较多的话，由于分区数据需要在节点之间进行迁移，所以需要一个过程。</p>
<p><strong>如果在紧急情况下， 通常在修改操作之前会首先修改主题的存储时间，适当降低存储数据量</strong>，这样可以加快数据的迁移。</p>
<p>分区重分配成功后，结果如下：</p>
<p><img src="assets/2c3636fd37fdd69b2e3d7605a512f8a3-20220924201042-5cq7y87.png" alt="" /></p>
<p>可以看到，新扩容的节点 4 上已经有主分区了，这样它就可以接受数据的读写请求了。</p>
<h2>集群缩容</h2>
<p>大促结束后，为了节省资源，通常需要对集群进行缩容处理。将节点从集群中移除的基本原则是，存储在这些节点上的消息必须完成消费，否则会造成消息消费丢失。</p>
<p>首先我们来看一下 RocketMQ 节点的缩容。</p>
<p>双十一过后，我们需要将 192.168.3.106 的节点下线，但是，直接把节点从集群中摘除是不可行的。我们通常要先关闭写权限，避免新的数据再写入该节点，然后等消息过期再下线。具体有两个步骤。</p>
<p>**第一步：**关闭节点的写权限。具体命令如下：</p>
<pre><code class="language-bash">sh ./mqadmin updateBrokerConfig -b 127.0.0.1:10911 -n 127.0.0.1:9876 -k brokerPermission -v 4
</code></pre>
<p>**第二步：**为了保守起见，通常要等待消息过期后，再关闭 Broker。如果消息的存储时间为 72 小时，那要在关闭写权限 3 天之后才可以下线该节点。在此期间，该节点还是可以提供读取服务，也就是说，存在这个节点的消息仍然可以被消费端消费。</p>
<p>Kafka 的缩容需要分情况处理。</p>
<p>如果 Kafka 集群中所有主题都是多副本的话，这样每一个分区都会有多个副本，并且这些副本会分布在不同的节点上，缩容的时候直接停止一个机器即可。</p>
<p>但如果 Kafka 中有些主题是采取的单副本，要想缩容，就需要将这些单副本的主题再次进行分区重分配，把这些单副本主题的分片转移到其他节点。然后就可以直接停掉机器了。</p>
<h2>分区扩容</h2>
<p>除了在集群维度扩容和缩容外，无论是 RocketMQ 还是 Kafka 都支持分区级别的扩容。</p>
<p>在 RocketMQ 中为主题进行队列扩容比较简单，只需要执行一条命令：</p>
<pre><code class="language-bash">sh ./mqadmin updateTopic -n 127.0.0.1:9876 -c DefaultCluster -t dw_test_01 -r 8 -w 8
</code></pre>
<p>-w 、-r 分别指定扩容后的队列数。其中 -w 表示写队列个数，-r 表示读队列个数，在进行主题扩容时，它们必须一致。</p>
<p>在 Kafka 中扩容分区同样只需要执行一条命令：</p>
<pre><code class="language-bash">./kafka-topics.sh --bootstrap-server 127.0.0.1:9092 --topic dw_test_topic_0709003  --partitions 8  --alter
</code></pre>
<p>其中，“–partitions”表示要扩容后的分片数量。</p>
<h2>分区缩容</h2>
<p>再来看分区缩容。</p>
<p>Kafka 目前不支持分区缩容，也就是说，一个主题的分区数量只能增加不能减少。而 RocketMQ 可以无缝实现缩容。</p>
<p>在 RocketMQ 要减少主题的分区数量，通常需要经过两步。</p>
<p>**第一步：**将主题的写队列更改为缩容后的队列，例如 dw_test_01 这个主题原本有 8 个队列，现在要缩容为 4，就将主题的写队列改为 4。具体的命令如下：</p>
<pre><code class="language-bash">sh ./mqadmin updateTopic -n 127.0.0.1:9876 -c DefaultCluster -t dw_test_01 -r 8 -w 4
</code></pre>
<p>**第二步：**等消息达到过期时间后，再将读队列数量变更为缩容后的队列。命令如下：</p>
<pre><code class="language-bash">sh ./mqadmin updateTopic -n 127.0.0.1:9876 -c DefaultCluster -t dw_test_01 -r 4 -w 4
</code></pre>
<h2>位点重置</h2>
<p>在生产实践中，还有一个非常高频的动作是位点重置（回溯）。</p>
<p>RocketMQ 不需要停止消费组就可以进行位点回溯，只需要运维人员执行如下命令：</p>
<pre><code class="language-bash">sh ./mqadmin resetOffsetByTime -g dw_test_mq_consuemr_test_01 -n 127.0.0.1:9876 -t dw_zms_test_topic -s '2022-07-10#10:00:00:000'
</code></pre>
<p>这里重点说一下 -s 参数，它表示回溯时间。其中：</p>
<ul>
<li>
<p>now 或者 currentTimeMillis 表示当前时间；</p>
</li>
<li>
<p>yyyy-MM-dd#HH:mm:ss:SSS 表示具体的时间戳。在执行命令时，需要严格按照格式，否则会抛出空指针异常，这个错误会让人看得莫名其妙。</p>
</li>
</ul>
<p>运行的结果如下：</p>
<p><img src="assets/be85a10c72ab7a2cfb146d4d23bcbec9-20220924201042-89plro6.png" alt="" /></p>
<p>我们再来看一下 Kafka 的位点回溯。</p>
<p>kafka 中在进行位点重置之前，首先需要停止该消费组内所有的消费者，然后执行如下命令：</p>
<pre><code class="language-bash">./kafka-consumer-groups.sh --bootstrap-server 127.0.0.1:9092 --group dw_test_consumer_20220710001 --reset-offsets --to-datetime '2022-07-10T00:00:00.000' --topic dw_test_topic_0709003  --execute
</code></pre>
<p>命令的运行结果如下：</p>
<p><img src="assets/76e147d8667203da55257a5e103d3320-20220924201042-5ip8bkr.png" alt="" /></p>
<p>其中，NEW-OFFSET 表示当时的位点，消费组启动时会从该位点开始消费。</p>
<h2><strong>RocketMQ NameServer 的扩容与下线</strong></h2>
<p>在生产环境中，RocketMQ 还有一个重要组件是 NameServer。它的扩容与缩容也需要特别注意，避免操作过程造成人为的数据不一致。</p>
<p>举个例子，如果现在我们需要将 2 个节点的 NameServer 扩容为 3 个节点，需求如下图所示：</p>
<p><img src="assets/465a32ee8315ba55351be2c6e98634b4-20220924201043-beldx47.jpg" alt="" /></p>
<p>首先要在新的机器上安装好 NameServer。</p>
<p>然后更新两台 Broker 的配置文件，让 Broker 能够感知 NameServer 的存在，具体的配置项：</p>
<pre><code class="language-properties">namesrvAddr=192.168.3.100:9876;192.168.3.101:9876;192.168.3.107:9876
</code></pre>
<p>紧接着，依次重启 Broker。</p>
<p>这样，NameServer 就扩容完成了。</p>
<p>乍一看这个过程很简单，但你一定要注意的是，**集群内的 Broker 没有全部重启时，新加入集群的 NameServer 地址是不能让消息发送 / 消息消费客户端使用的。**因为这时候新的 NameServer 上的路由信息会和集群内其他 NamServer 存储的信息不一致。</p>
<p>NameServer 的下线就比较简单了。直接先 kill 掉 NameServer 进程，这时，无论是 Broker、还是消息发送、消息消费客户端都会抛出错误，但这个错误不影响使用。</p>
<p>然后依次更新 Broker 配置文件中的 namesrvAddr，移除已下线的 NameServer 地址并依次重启。</p>
<p>在生产实践中，NameServer 的扩容还是比较少见的，更多的是更换机器。举个例子，192.168.3.100 这台机器由于内存、磁盘等故障，需要被下线。但为了保证 NameServer 节点数量不受影响，我们通常还会在一台新机器上部署一台新的 NameServer。同时，为了避免客户端或 Broker 需要更新 NameServer 列表，更换机器时还要 IP 保持不变。</p>
<h2><strong>运维技巧</strong></h2>
<p>最后，我们再来看看运维命令。</p>
<p>无论是 RocketMQ 还是 Kafka 都提供了丰富的运维命令，这可以让运维人员更好地管理集群。但是，运维命令这么多，而且每一个命令的参数也很多，我们应该怎么学习这些命令呢？</p>
<p>其实不需要死记硬背，这些运维命令自带帮助手册，运维命令的安装目录就是中间件的 bin 目录。</p>
<p>通过下面的命令，我们可以快速查看 RocketMQ 拥有哪些运维命令：</p>
<pre><code class="language-bash">sh ./mqadmin
</code></pre>
<h1>该命令的输出结果如下：</h1>
<pre><code class="language-bash">
sh ./mqadmin
# 该命令的输出结果如下：
The most commonly used mqadmin commands are:
   updateTopic          Update or create topic
   deleteTopic          Delete topic from broker and NameServer.
   updateSubGroup       Update or create subscription group
   deleteSubGroup       Delete subscription group from broker.
   updateBrokerConfig   Update broker's config
   updateTopicPerm      Update topic perm
   topicRoute           Examine topic route info
   topicStatus          Examine topic Status info
   topicClusterList     get cluster info for topic
   brokerStatus         Fetch broker runtime status data
   queryMsgById         Query Message by Id
   queryMsgByKey        Query Message by Key
   queryMsgByUniqueKey  Query Message by Unique key
   queryMsgByOffset     Query Message by offset
   QueryMsgTraceById    query a message trace
   printMsg             Print Message Detail
   printMsgByQueue      Print Message Detail
   sendMsgStatus        send msg to broker.
   brokerConsumeStats   Fetch broker consume stats data
   producerConnection   Query producer's socket connection and client version
   consumerConnection   Query consumer's socket connection, client version and subscription
   producerConnectionAll Query all producer's socket connection and client version
   consumerProgress     Query consumers's progress, speed
   consumerStatus       Query consumer's internal data structure
   cloneGroupOffset     clone offset from other group.
   clusterList          List all of clusters
   topicList            Fetch all topic list from name server
   updateKvConfig       Create or update KV config.
   deleteKvConfig       Delete KV config.
   wipeWritePerm        Wipe write perm of broker in all name server
   resetOffsetByTime    Reset consumer offset by timestamp(without client restart).
   updateOrderConf      Create or update or delete order conf
   cleanExpiredCQ       Clean expired ConsumeQueue on broker.
   cleanUnusedTopic     Clean unused topic on broker.
   startMonitoring      Start Monitoring
   statsAll             Topic and Consumer tps stats
   allocateMQ           Allocate MQ
   checkMsgSendRT       check message send response time
   clusterRT            List All clusters Message Send RT
   getNamesrvConfig     Get configs of name server.
   updateNamesrvConfig  Update configs of name server.
   getBrokerConfig      Get broker config by cluster or special broker!
   queryCq              Query cq command.
   sendMessage          Send a message
   consumeMessage       Consume message
   updateAclConfig      Update acl config yaml file in broker
   deleteAccessConfig   Delete Acl Config Account in broker
   clusterAclConfigVersion List all of acl config version information in cluster
   updateGlobalWhiteAddr Update global white address for acl Config File in broker
   getAccessConfigSubCommand List all of acl config information in cluster
</code></pre>
<p>查看每一个命令的具体使用方法，可以使用如下命令：</p>
<pre><code class="language-bash">sh ./mqadmin updateTopic -h
</code></pre>
<p>同样 Kafka 的运维命令也在 bin 目录下：</p>
<p><img src="assets/f533de2cdc1c95a39b9cd9075c8df0e5-20220924201043-e0xmkqp.png" alt="" /></p>
<h2><strong>总结</strong></h2>
<p>好了，这节课就讲到这里。</p>
<p>中间件的稳定性大于一切，一旦发生故障，影响范围也比较大。所以我们不能把所有的鸡蛋放到一个“篮子”中，而是应该按照使用场景、应用特性等维度对集群进行合理规划，规划出一个一个的小集群。</p>
<p>中间件的运维必须遵循一个最基本的原则，那就是中间件做的变更要对业务无感知，对现有业务的运行无任何影响。</p>
<p>刚才，我结合我的运维实践经验，对集群扩容、缩容、分区扩容、缩容、位点重置、NameServer 下线等常见场景做了演练，你可以对比自己的实际经验进行总结与归纳。</p>
<h2><strong>课后题</strong></h2>
<p>学完今天的内容，请你思考下面这个问题。</p>
<p>在进行消费位点回溯时，我们说 Kafka 必须先停掉消费者，但 RocketMQ 却不需要，你知道 RocketMQ 是怎么做到的吗？</p>
<p>欢迎你在留言区与我交流讨论，我们下节课见！</p>
</div>
                        </div>
                        <div>
                            <div style="float: left">
                                <a href="16%20%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%A6%82%E4%BD%95%E6%8F%90%E5%8D%87RocketMQ%E9%A1%BA%E5%BA%8F%E6%B6%88%E8%B4%B9%E6%80%A7%E8%83%BD%EF%BC%9F.md.html">上一页</a>
                            </div>
                            <div style="float: right">
                                <a href="18%20%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%A6%82%E4%BD%95%E6%8E%92%E6%9F%A5RocketMQ%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E8%B6%85%E6%97%B6%E6%95%85%E9%9A%9C%EF%BC%9F.md.html">下一页</a>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="copyright"><p>© 2019 - 2023 <a href="../../cdn-cgi/l/email-protection.html#462a2a2a7f727777767106212b272f2a6825292b" target="_blank">Liangliang Lee</a>. Powered by <a href="https://vertx.io/" target="_blank">Vert.x</a> and <a href="https://github.com/kaiiiz/hexo-theme-book" target="_blank">hexo-theme-book</a>.</p></div>
        </div>

        <a class="off-canvas-overlay" onclick="hide_canvas()"></a>
    </div>
<script data-cfasync="false" src="../../cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/vb26e4fa9e5134444860be286fd8771851679335129114" integrity="sha512-M3hN/6cva/SjwrOtyXeUa5IuCT0sedyfT+jK/OV+s+D0RnzrTfwjwJHhd+wYfMm9HJSrZ1IKksOdddLuN6KOzw==" data-cf-beacon='{"rayId":"7af09744982afa86","version":"2023.3.0","r":1,"token":"1f5d475227ce4f0089a7cff1ab17c0f5","si":100}' crossorigin="anonymous"></script>
</body>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NPSEEVD756"></script>
<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'G-NPSEEVD756');
    var path = window.location.pathname
    var cookie = getCookie("lastPath");
    console.log(path)
    if (path.replace("/", "") === "") {
        if (cookie.replace("/", "") !== "") {
            console.log(cookie)
            document.getElementById("tip").innerHTML = "<a href='" + cookie + "'>跳转到上次进度</a>"
        }
    } else {
        setCookie("lastPath", path)
    }

    function setCookie(cname, cvalue) {
        var d = new Date();
        d.setTime(d.getTime() + (180 * 24 * 60 * 60 * 1000));
        var expires = "expires=" + d.toGMTString();
        document.cookie = cname + "=" + cvalue + "; " + expires + ";path = /";
    }

    function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i].trim();
            if (c.indexOf(name) === 0) return c.substring(name.length, c.length);
        }
        return "";
    }

    hljs.initHighlightingOnLoad()

</script>

</html>
