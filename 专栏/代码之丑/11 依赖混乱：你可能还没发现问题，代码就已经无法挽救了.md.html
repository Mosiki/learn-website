<!DOCTYPE html>
<!-- saved from url=(0046)https://kaiiiz.github.io/hexo-theme-book-demo/ -->
<html xmlns="http://www.w3.org/1999/xhtml">

<head>

    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
        <link rel="icon" href="../../static/favicon.png">
        <title>11 依赖混乱：你可能还没发现问题，代码就已经无法挽救了.md</title>
        <!-- Spectre.css framework -->
        <link rel="stylesheet" href="../../static/index.css">
        <link rel="stylesheet"
              href="../../static/highlight.min.css">
        <script src="../../static/highlight.min.js"></script>
        <!-- theme css & js -->
        <meta name="generator" content="Hexo 4.2.0">
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5295275829820252"
                crossorigin="anonymous"></script>
        <script async defer data-website-id="83e5d5db-9d06-40e3-b780-cbae722fdf8c" src="https://analyze.lianglianglee.com/umami.js"></script>
    </head>

<body>

    <div class="book-container">
        <div class="book-sidebar">
            <div class="book-brand">
                <a href="../../index.html">
                    <img src="../../static/favicon.png">
                    <span>技术文章摘抄</span>
                </a>
            </div>
            <div class="book-menu uncollapsible">
                <ul class="uncollapsible">
                    <li><a href="../../index.html" class="current-tab">首页</a></li>
                </ul>

                <ul class="uncollapsible">
                    <li><a href="../index.html">上一级</a></li>
                </ul>

                <ul class="uncollapsible">
                    <li>

                        
                        <a href="00%20%E5%BC%80%E7%AF%87%E8%AF%8D%20%E8%BF%99%E4%B8%80%E6%AC%A1%EF%BC%8C%E6%88%91%E4%BB%AC%E4%BB%8E%E2%80%9C%E4%B8%91%E2%80%9D%E4%BB%A3%E7%A0%81%E5%87%BA%E5%8F%91.md.html">00 开篇词 这一次，我们从“丑”代码出发.md</a>

                    </li>
                    <li>

                        
                        <a href="01%20%E7%BC%BA%E4%B9%8F%E4%B8%9A%E5%8A%A1%E5%90%AB%E4%B9%89%E7%9A%84%E5%91%BD%E5%90%8D%EF%BC%9A%E5%A6%82%E4%BD%95%E7%B2%BE%E5%87%86%E5%91%BD%E5%90%8D%EF%BC%9F.md.html">01 缺乏业务含义的命名：如何精准命名？.md</a>

                    </li>
                    <li>

                        
                        <a href="02%20%E4%B9%B1%E7%94%A8%E8%8B%B1%E8%AF%AD%EF%BC%9A%E7%AB%99%E5%9C%A8%E4%B8%AD%E5%9B%BD%E4%BA%BA%E7%9A%84%E8%A7%86%E8%A7%92%E6%9D%A5%E7%9C%8B%E8%8B%B1%E6%96%87%E5%91%BD%E5%90%8D.md.html">02 乱用英语：站在中国人的视角来看英文命名.md</a>

                    </li>
                    <li>

                        
                        <a href="03%20%E9%87%8D%E5%A4%8D%E4%BB%A3%E7%A0%81%EF%BC%9A%E7%AE%80%E5%8D%95%E9%9C%80%E6%B1%82%E5%88%B0%E5%A4%84%E4%BF%AE%E6%94%B9%EF%BC%8C%E6%80%8E%E4%B9%88%E5%8A%9E%EF%BC%9F.md.html">03 重复代码：简单需求到处修改，怎么办？.md</a>

                    </li>
                    <li>

                        
                        <a href="04%20%E9%95%BF%E5%87%BD%E6%95%B0%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%A0%E6%80%BB%E6%98%AF%E4%B8%8D%E5%8F%AF%E9%81%BF%E5%85%8D%E5%9C%B0%E5%86%99%E5%87%BA%E9%95%BF%E5%87%BD%E6%95%B0%EF%BC%9F.md.html">04 长函数：为什么你总是不可避免地写出长函数？.md</a>

                    </li>
                    <li>

                        
                        <a href="05%20%E5%A4%A7%E7%B1%BB%EF%BC%9A%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%E5%86%99%E5%87%BA%E9%9A%BE%E4%BB%A5%E7%90%86%E8%A7%A3%E7%9A%84%E5%A4%A7%E7%B1%BB%EF%BC%9F.md.html">05 大类：如何避免写出难以理解的大类？.md</a>

                    </li>
                    <li>

                        
                        <a href="06%20%E9%95%BF%E5%8F%82%E6%95%B0%E5%88%97%E8%A1%A8%EF%BC%9A%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E4%B8%8D%E5%90%8C%E7%B1%BB%E5%9E%8B%E7%9A%84%E9%95%BF%E5%8F%82%E6%95%B0%EF%BC%9F.md.html">06 长参数列表：如何处理不同类型的长参数？.md</a>

                    </li>
                    <li>

                        
                        <a href="07%20%E6%BB%A5%E7%94%A8%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5%EF%BC%9A%E5%87%BA%E7%8E%B0%E6%8E%A7%E5%88%B6%E7%BB%93%E6%9E%84%EF%BC%8C%E5%A4%9A%E5%8D%8A%E6%98%AF%E9%94%99%E8%AF%AF%E7%9A%84%E6%8F%90%E7%A4%BA.md.html">07 滥用控制语句：出现控制结构，多半是错误的提示.md</a>

                    </li>
                    <li>

                        
                        <a href="08%20%E7%BC%BA%E4%B9%8F%E5%B0%81%E8%A3%85%EF%BC%9A%E5%A6%82%E4%BD%95%E5%BA%94%E5%AF%B9%E7%81%AB%E8%BD%A6%E4%BB%A3%E7%A0%81%E5%92%8C%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B%E5%81%8F%E6%89%A7%E9%97%AE%E9%A2%98%EF%BC%9F.md.html">08 缺乏封装：如何应对火车代码和基本类型偏执问题？.md</a>

                    </li>
                    <li>

                        
                        <a href="09%20%E5%8F%AF%E5%8F%98%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%9A%E4%B8%8D%E8%A6%81%E8%AE%A9%E4%BD%A0%E7%9A%84%E4%BB%A3%E7%A0%81%E2%80%9C%E5%A4%B1%E6%8E%A7%E2%80%9D.md.html">09 可变的数据：不要让你的代码“失控”.md</a>

                    </li>
                    <li>

                        
                        <a href="10%20%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E4%B8%8E%E8%B5%8B%E5%80%BC%E5%88%86%E7%A6%BB%EF%BC%9A%E6%99%AE%E9%80%9A%E7%9A%84%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%EF%BC%8C%E6%80%8E%E4%B9%88%E4%B9%9F%E6%9C%89%E5%9D%8F%E5%91%B3%E9%81%93%EF%BC%9F.md.html">10 变量声明与赋值分离：普通的变量声明，怎么也有坏味道？.md</a>

                    </li>
                    <li>

                        <a class="current-tab" href="11%20%E4%BE%9D%E8%B5%96%E6%B7%B7%E4%B9%B1%EF%BC%9A%E4%BD%A0%E5%8F%AF%E8%83%BD%E8%BF%98%E6%B2%A1%E5%8F%91%E7%8E%B0%E9%97%AE%E9%A2%98%EF%BC%8C%E4%BB%A3%E7%A0%81%E5%B0%B1%E5%B7%B2%E7%BB%8F%E6%97%A0%E6%B3%95%E6%8C%BD%E6%95%91%E4%BA%86.md.html">11 依赖混乱：你可能还没发现问题，代码就已经无法挽救了.md</a>
                        

                    </li>
                    <li>

                        
                        <a href="12%20%E4%B8%8D%E4%B8%80%E8%87%B4%E7%9A%84%E4%BB%A3%E7%A0%81%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%A0%E7%9A%84%E4%BB%A3%E7%A0%81%E6%80%BB%E8%A2%AB%E5%90%90%E6%A7%BD%E9%9A%BE%E6%87%82%EF%BC%9F.md.html">12 不一致的代码：为什么你的代码总被吐槽难懂？.md</a>

                    </li>
                    <li>

                        
                        <a href="13%20%E8%90%BD%E5%90%8E%E7%9A%84%E4%BB%A3%E7%A0%81%E9%A3%8E%E6%A0%BC%EF%BC%9A%E4%BD%BF%E7%94%A8%E2%80%9C%E6%96%B0%E2%80%9D%E7%9A%84%E8%AF%AD%E8%A8%80%E7%89%B9%E6%80%A7%E5%92%8C%E7%A8%8B%E5%BA%8F%E5%BA%93%E5%8D%87%E7%BA%A7%E4%BD%A0%E7%9A%84%E4%BB%A3%E7%A0%81.md.html">13 落后的代码风格：使用“新”的语言特性和程序库升级你的代码.md</a>

                    </li>
                    <li>

                        
                        <a href="14%20%E5%A4%9A%E4%B9%85%E8%BF%9B%E8%A1%8C%E4%B8%80%E6%AC%A1%E4%BB%A3%E7%A0%81%E8%AF%84%E5%AE%A1%E6%9C%80%E5%90%88%E9%80%82%EF%BC%9F.md.html">14 多久进行一次代码评审最合适？.md</a>

                    </li>
                    <li>

                        
                        <a href="15%20%E6%96%B0%E9%9C%80%E6%B1%82%E7%A0%B4%E5%9D%8F%E4%BA%86%E4%BB%A3%E7%A0%81%EF%BC%8C%E6%80%8E%E4%B9%88%E5%8A%9E%EF%BC%9F.md.html">15 新需求破坏了代码，怎么办？.md</a>

                    </li>
                    <li>

                        
                        <a href="16%20%E7%86%8A%E8%8A%82%EF%BC%9A%E4%BB%80%E4%B9%88%E4%BB%A3%E7%A0%81%E5%BA%94%E8%AF%A5%E8%A2%AB%E9%87%8D%E6%9E%84%EF%BC%9F.md.html">16 熊节：什么代码应该被重构？.md</a>

                    </li>
                    <li>

                        
                        <a href="17%20%E8%AF%BE%E5%89%8D%E4%BD%9C%E4%B8%9A%E7%82%B9%E8%AF%84%EF%BC%9A%E5%8F%91%E7%8E%B0%E2%80%9C%E4%BD%A0%E2%80%9D%E4%BB%A3%E7%A0%81%E9%87%8C%E7%9A%84%E5%9D%8F%E5%91%B3%E9%81%93.md.html">17 课前作业点评：发现“你”代码里的坏味道.md</a>

                    </li>
                    <li>

                        
                        <a href="%E7%BB%93%E6%9D%9F%E8%AF%AD%20%E5%86%99%E4%BB%A3%E7%A0%81%E6%98%AF%E4%B8%80%E4%BB%B6%E5%8F%AF%E4%BB%A5%E4%B8%80%E7%94%9F%E7%B2%BE%E8%BF%9B%E7%9A%84%E4%BA%8B.md.html">结束语 写代码是一件可以一生精进的事.md</a>

                    </li>
                </ul>

            </div>
        </div>

        <div class="sidebar-toggle" onclick="sidebar_toggle()" onmouseover="add_inner()" onmouseleave="remove_inner()">
            <div class="sidebar-toggle-inner"></div>
        </div>

        <script>
            function add_inner() {
                let inner = document.querySelector('.sidebar-toggle-inner')
                inner.classList.add('show')
            }

            function remove_inner() {
                let inner = document.querySelector('.sidebar-toggle-inner')
                inner.classList.remove('show')
            }

            function sidebar_toggle() {
                let sidebar_toggle = document.querySelector('.sidebar-toggle')
                let sidebar = document.querySelector('.book-sidebar')
                let content = document.querySelector('.off-canvas-content')
                if (sidebar_toggle.classList.contains('extend')) { // show
                    sidebar_toggle.classList.remove('extend')
                    sidebar.classList.remove('hide')
                    content.classList.remove('extend')
                } else { // hide
                    sidebar_toggle.classList.add('extend')
                    sidebar.classList.add('hide')
                    content.classList.add('extend')
                }
            }


            function open_sidebar() {
                let sidebar = document.querySelector('.book-sidebar')
                let overlay = document.querySelector('.off-canvas-overlay')
                sidebar.classList.add('show')
                overlay.classList.add('show')
            }
            function hide_canvas() {
                let sidebar = document.querySelector('.book-sidebar')
                let overlay = document.querySelector('.off-canvas-overlay')
                sidebar.classList.remove('show')
                overlay.classList.remove('show')
            }

        </script>

        <div class="off-canvas-content">
            <div class="columns">
                <div class="column col-12 col-lg-12">
                    <div class="book-navbar">
                        <!-- For Responsive Layout -->
                        <header class="navbar">
                            <section class="navbar-section">
                                <a onclick="open_sidebar()">
                                    <i class="icon icon-menu"></i>
                                </a>
                            </section>
                        </header>
                    </div>
                    <div class="book-content" style="max-width: 960px; margin: 0 auto;
    overflow-x: auto;
    overflow-y: hidden;">
                        <div class="book-post">
                            <p id="tip" align="center"></p>
                            <div><h1>11 依赖混乱：你可能还没发现问题，代码就已经无法挽救了</h1>
<p>　　你好，我是郑晔。</p>
<p>　　我们前面已经讲了许多坏味道，无论是你很容易接受的，还是挑战你编程习惯的，它们都有相对直观的表现形式，属于你很容易一下子就看出来问题的。这一讲，我们要讲的坏味道就不属于一下子就能看出来的，需要你稍微仔细一点看代码才会发现问题，那就是依赖关系。</p>
<p>　　我前面在讲“大类”这个坏味道的时候曾经说过，为了避免同时面对所有细节，我们需要把程序进行拆分，分解成一个又一个的小模块。但随之而来的问题就是，我们需要把这些拆分出来的模块按照一定的规则重新组装在一起，这就是依赖的缘起。</p>
<p>　　一个模块要依赖另外一个模块完成完整的业务功能，而到底怎么去依赖，这里就很容易产生问题。</p>
<h2>缺少防腐层</h2>
<p>　　我们还是先来看一段代码：</p>
<pre><code class="language-java">　　@PostMapping(&quot;/books&quot;)
　　public NewBookResponse createBook(final NewBookRequest request) {
　　  boolean result = this.service.createBook(request);
　　  ...

　　}
</code></pre>
<p>　　这段代码是创建一部作品的入口，也就是说，它提供了一个 REST 服务，只要我们对 /books 这个地址发出一个 POST 请求，就可以创建一部作品出来。那么，这段代码有问题吗？</p>
<p>　　按照一般代码的分层逻辑，一个 Resource （有的团队称之为 Controller）调用一个 Service，这符合大多数人的编程习惯，所以看起来，这段代码简直是正常得不能再正常了，这能有什么问题？</p>
<p>　　从 Resource 调用 Service，这几乎是行业里的标准做法，是没有问题的，但问题出在传递的参数上。请问，这个 NewBookRequest 的参数类应该属于哪一层，是 resource 层，还是 service 层呢？</p>
<p>　　一般来说，既然它是一个请求参数，通常要承载着诸如参数校验和对象转换的职责，按照我们通常的理解，它应该属于 resource 层。如果这个理解是正确的，问题就来了，它为什么会传递给 service 层呢？</p>
<p>　　按照通常的架构设计原则，service 层属于我们的核心业务，而 resource 层属于接口。二者相较而言，核心业务的重要程度更高一些，所以，它的稳定程度也应该更高一些。同样的业务，我们可以用 REST 的方式对外提供，也可以用 RPC 的方式对外提供。</p>
<p>　　说到这，你就会发现一个问题，NewBookRequest 这个本来应该属于接口层的参数，现在成了核心业务的一部分，也就是说，即便将来我们提供了 RPC 的接口，它也要知道 REST 的接口长什么样子，显然，这是有问题的。</p>
<p>　　既然 NewBookRequest 属于 resource 层是有问题的，那我们假设它属于 service 层呢？正如我们前面所说，一般请求都要承担对象校验和转化的工作。如果说这个类属于 service 层，但它用在了 resource 的接口上，作为 resource 的接口，它会承载一些校验和对象转换的角色，而 service 层的参数是不需要关心这些的。如果 NewBookRequest 属于 service 层，那校验和对象转换的职责到底由谁来完成呢？</p>
<p>　　还有更关键的一点是，有时候 service 层的参数和 resource 层的参数并不是严格地一一对应。比如，创建作品时，我们需要一个识别作者身份的用户 ID，而这个参数并不是通过客户端发起的请求参数带过来，而是根据用户登录信息进行识别的。所以，用 service 层的参数做 resource 层的参数，就存在差异的参数如何处理的问题。</p>
<p>　　你有没有发现，我们突然陷入了一种两难的境地，<strong>如此一个简单的参数，放到哪个层里都有问题。</strong></p>
<p>　　这是一种非常常见的代码，你去翻看自己的代码仓库，也许就能找到类似的代码。不过，很有可能在学习到这一课之前，你根本没有想过这种代码也是有问题的。</p>
<p>　　那这个问题该如何解呢？</p>
<p>　　其实，之所以我们这么纠结，一个关键点在于，我们缺少了一个模型。</p>
<p>　　NewBookRequest 之所以弄得如此“里外不是人”，主要就是因为它只能扮演一个层中的模型，所以，我们只要再引入一个模型就可以破解这个问题。</p>
<pre><code class="language-java">　　class NewBookParameter {

　　  ...

　　}

　　class NewBookRequest {

　　  public NewBookParameters toNewBookRequest() {
　　    ...
　　  }

　　}

　　@PostMapping(&quot;/books&quot;)
　　public NewBookResponse createBook(final NewBookRequest request) {
　　  boolean result = this.service.createBook(request.toNewBookParameter());
　　  ...
　　}
</code></pre>
<p>　　这里我们引入了一个 NewBookParameter 类，把它当作 service 层创建作品的入口，而在 resource 中，我们将 NewBookRequest 这个请求类的对象转换成了 NewBookParameter 对象，然后传到 service 层。</p>
<p>　　在这个结构中，NewBookParameter 属于 service 层，而 NewBookRequest 属于 resource 层，二者相互独立，我们之前纠结的问题也就不复存在了。</p>
<p>　　好，现在我们理解了，通过增加一个模型，我们就破解了依赖关系上的纠结。</p>
<p>　　也许你会说，虽然它们成了两个类，但是，它们两个应该长得一模一样吧。这算不算是一种重复呢？但我的问题是，它们两个为什么要一样呢？有了两层不同的参数，我们就可以给不同层次上的模型以不同的约定了。</p>
<p>　　比如，对于 resource 层的请求对象，因为它的主要作用是传输，所以，一般来说，我们约定请求对象的字段主要是基本类型。而 service 的参数对象，因为它已经是核心业务的一部分，就需要全部转化为业务对象。举个例子，比如，同样表示价格，在请求对象中，我们可以是一个 double 类型，而在业务参数对象中，它应该是 Price 类型。</p>
<p>　　我们再来解决 resource 层参数和 service 层参数不一致的情况，现在二者分开了，那我们就很清楚地知道，其实，就是在业务参数对象构造的时候，传入必需的参数即可。比如，如果我们需要传入 userId，可以这么做：</p>
<pre><code class="language-java">　　class NewBookRequest {
      
　　  public NewBookParameters toNewBookRequest(long userId) {
　　    ...
　　  }
　　}

　　@PostMapping(&quot;/books&quot;)
　　public NewBookResponse createBook(final NewBookRequest request, final Authentication authentication) {

　　  long userId = getUserIdentity(authentication);
　　  boolean result = this.service.createBook(request.toNewBookParameter(userId));
　　  ...
　　}
</code></pre>
<p>　　我们之所以能注意到这个坏味道，就是从依赖关系入手发现的问题。我当初注意到这段代码，因为我团队内部的约定是，所有的请求对象都属于 resource 层，但在这段代码里，service 层出现了 resource 层的对象，它背离了我们对依赖关系设计的约定，所以，这个问题就浮出了水面。</p>
<p>　　实际上，这个问题也是一个典型的软件设计问题：缺少防腐层。我在《[10x 程序员工作法]》和《[软件设计之美]》两个专栏都讲到过防腐层的概念，只不过，讲防腐层的时候，我举的例子都是与外部系统集成，其中的观点就是通过防腐层将外部系统和核心业务隔离开来。</p>
<p>　　而很多人初见这个例子，可能压根想不到它与防腐层的关系，那只不过是因为你对这种结构太熟悉了。其实，resource 层就是外部请求和核心业务之间的防腐层。只要理解了这一点，你就能理解这里要多构建出一个业务参数对象的意义了。那下面这段代码，想必你也能轻易地发现问题：</p>
<pre><code class="language-java">　　@Entity
　　@Table(name = &quot;user&quot;)
　　@JsonIgnoreProperties(ignoreUnknown = true)
　　class User {

　　  ...

　　}
</code></pre>
<p>　　这是一个 User 类的声明，它有 @Entity 这个 Anntation，表示它是一个业务实体的对象，但它的上面还出现了 @JsonIgnoreProperties，这是就是处理 JSON 的一个 Annotation。JSON 会在哪用到，通常都是在传输中。业务实体和传输对象应该具备的特质在同一个类中出现，显然，这也是没有构建好防腐层的结果，把两个职责混在了一起。</p>
<h2>业务代码里的具体实现</h2>
<p>　　好，我们再来看一段代码：</p>
<pre><code class="language-java">　　@Task
　　public void sendBook() {

　　  try {
　　    this.service.sendBook();
　　  } catch (Throwable t) {
　　    this.feishuSender.send(new SendFailure(t)));
　　    throw t;
　　  }
　　}
</code></pre>
<p>　　这是我们在“[重复代码]”那一讲中提到的一个发送作品信息的函数，这里的重点在于，一旦发送过程出了问题，要通过即时通信工具发送给相关人等，以防系统出现问题无人发觉。只不过，这里给出的是它最初的样子，也就是通过飞书进行消息发送。</p>
<p>　　因为需求是通过飞书发送，所以，这里就写了飞书发送。这看上去简直是一个合理得不能再合理的做法了。</p>
<p>　　但是，请稍等！这是一种符合直觉的做法，然而，它却不符合设计原则，它违反了依赖倒置原则。</p>
<p>　　我曾经在《[软件设计之美]》中专门用了一讲的篇幅讲解依赖倒置原则，这里我们简单回顾一下：</p>
<p>　　高层模块不应依赖于低层模块，二者应依赖于抽象。</p>
<p>　　High-level modules should not depend on low-level modules. Both should depend on abstractions.</p>
<p>　　抽象不应依赖于细节，细节应依赖于抽象。</p>
<p>　　Abstractions should not depend on details. Details (concrete implementations) should depend on abstractions.</p>
<p>　　我之所以会注意到这段代码，因为在一段业务处理中出现了一个具体的实现，也就是这里的 feishuSender。</p>
<p>　　你需要知道，<strong>业务代码中任何与业务无关的东西都是潜在的坏味道</strong>。</p>
<p>　　在这里，飞书肯定不是业务的一部分，它只是当前选择的一个具体实现。换言之，是否选择飞书，与团队当前的状态是相关的，如果哪一天团队切换即时通信软件，这个实现就需要换掉。但是，团队是不可能切换业务的，一旦切换，那就是一个完全不同的系统了。</p>
<p>　　<strong>识别一个东西是业务的一部分，还是一个可以替换的实现，我们不妨问问自己，如果不用它，是否还有其它的选择？</strong></p>
<p>　　就像这里，飞书是可以被其它即时通信软件替换的。另外，常见的中间件，比如，Kafka、Redis、MongoDB 等等，通常也都是一个具体的实现，其它中间件都可以把它替换掉。所以，它们在业务代码里出现，那一定就是一个坏味道了。</p>
<p>　　既然我们已经知道了，这些具体的东西是一种坏味道，那该怎么解决呢？你可以引入一个模型，也就是这个具体实现所要扮演的角色，通过它，将业务和具体的实现隔离开来。</p>
<pre><code class="language-java">　　interface FailureSender {

　　  void send(SendFailure failure);

　　}

　　class FeishuFailureSenderS implements FailureSender {

　　  ...

　　}
</code></pre>
<p>　　这里我们通过引入一个 FailureSender，业务层只依赖于这个 FailureSender 的接口就好，而具体的飞书实现可以通过依赖注入的方式注入进去。</p>
<p>　　依赖关系是软件开发中非常重要的一个东西，然而，很多程序员在写代码的时候，由于开发习惯的原因，常常会忽略掉依赖关系这件事本身。现在已经有一些工具，可以保证我们在写代码的时候，不会出现严重破坏依赖关系的情况，比如，像前面那种 service 层调用 resource 层的代码。</p>
<p>　　在 Java 世界里，我们就可以用 <a href="https://www.archunit.org/">ArchUnit</a> 来保证这一切。看名字就不难发现，它是把这种架构层面的检查做成了单元测试，下面就是这样的一个单元测试：</p>
<pre><code class="language-java">　　@Test
　　public void should_follow_arch_rule() {

　　  JavaClasses clazz = new ClassFileImporter().importPackages(&quot;...&quot;);
　　  ArchRule rule = layeredArchitecture()
　　        .layer(&quot;Resource&quot;).definedBy(&quot;..resource..&quot;)
　　        .layer(&quot;Service&quot;).definedBy(&quot;..service..&quot;)
　　        .whereLayer(&quot;Resource&quot;).mayNotBeAccessedByAnyLayer()
　　        .whereLayer(&quot;Service&quot;).mayOnlyBeAccessedByLayers(&quot;Resource&quot;);
　　   rule.check(clazz);
　　}
</code></pre>
<p>　　在这里，我们定义了两个层，分别是 Resource 层和 Service 层，而且我们要求 Resource 层的代码不能被其它层访问，而 Service 层的代码只能由 Resource 层方法访问。这就是我们的架构规则，一旦代码里有违反这个架构规则的代码，这个测试就会失败，问题也就会暴露出来。</p>
<h2>总结时刻</h2>
<p>　　今天我们讲了由于代码依赖关系而产生的坏味道，一种是缺少防腐层，导致不同代码糅合在一起，一种是在业务代码中出现了具体的实现类。</p>
<p>　　缺少防腐层，会让请求对象传导到业务代码中，造成了业务与外部接口的耦合，也就是业务依赖了一个外部通信协议。一般来说，业务的稳定性要比外部接口高，这种反向的依赖就会让业务一直无法稳定下来，继而在日后带来更多的问题。解决方案自然就是引入一个防腐层，将业务和接口隔离开来。</p>
<p>　　业务代码中出现具体的实现类，实际上是违反了依赖倒置原则。因为违反了依赖倒置原则，业务代码也就不可避免地受到具体实现的影响，也就造成了业务代码的不稳定。识别一段代码是否属于业务，我们不妨问一下，看把它换成其它的东西，是否影响业务。解决这种坏味道就是引入一个模型，将业务与具体的实现隔离开来。</p>
<p>　　最后，我们还谈到了有些简单的依赖关系，可以通过工具来进行维护，比如 ArchUnit。</p>
<p>　　如果今天的内容你只能记住一件事，那请记住：<strong>代码应该向着稳定的方向依赖</strong>。</p>
<p>　　<img src="assets/1114d3ae0675a378ebefc42ddb803da9-20220725221625-e8spbmd.jpg" alt="" /></p>
<h2>思考题</h2>
<p>　　今天我们讲到了依赖关系，你可以用今天讲到的坏味道衡量一下自己的代码，看有哪些代码是有问题的，欢迎在留言区分享你的发现，也欢迎你把学到的知识分享给你的朋友。</p>
<p>　　感谢阅读，我们下一讲再见！</p>
</div>
                        </div>
                        <div>
                            <div style="float: left">
                                <a href="10%20%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E4%B8%8E%E8%B5%8B%E5%80%BC%E5%88%86%E7%A6%BB%EF%BC%9A%E6%99%AE%E9%80%9A%E7%9A%84%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%EF%BC%8C%E6%80%8E%E4%B9%88%E4%B9%9F%E6%9C%89%E5%9D%8F%E5%91%B3%E9%81%93%EF%BC%9F.md.html">上一页</a>
                            </div>
                            <div style="float: right">
                                <a href="12%20%E4%B8%8D%E4%B8%80%E8%87%B4%E7%9A%84%E4%BB%A3%E7%A0%81%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%A0%E7%9A%84%E4%BB%A3%E7%A0%81%E6%80%BB%E8%A2%AB%E5%90%90%E6%A7%BD%E9%9A%BE%E6%87%82%EF%BC%9F.md.html">下一页</a>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="copyright"><p>© 2019 - 2023 <a href="../../cdn-cgi/l/email-protection.html#6f030303565b5e5e5f582f08020e0603410c0002" target="_blank">Liangliang Lee</a>. Powered by <a href="https://vertx.io/" target="_blank">Vert.x</a> and <a href="https://github.com/kaiiiz/hexo-theme-book" target="_blank">hexo-theme-book</a>.</p></div>
        </div>

        <a class="off-canvas-overlay" onclick="hide_canvas()"></a>
    </div>
<script data-cfasync="false" src="../../cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/vb26e4fa9e5134444860be286fd8771851679335129114" integrity="sha512-M3hN/6cva/SjwrOtyXeUa5IuCT0sedyfT+jK/OV+s+D0RnzrTfwjwJHhd+wYfMm9HJSrZ1IKksOdddLuN6KOzw==" data-cf-beacon='{"rayId":"7af0cc6468cbd025","version":"2023.3.0","r":1,"token":"1f5d475227ce4f0089a7cff1ab17c0f5","si":100}' crossorigin="anonymous"></script>
</body>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NPSEEVD756"></script>
<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'G-NPSEEVD756');
    var path = window.location.pathname
    var cookie = getCookie("lastPath");
    console.log(path)
    if (path.replace("/", "") === "") {
        if (cookie.replace("/", "") !== "") {
            console.log(cookie)
            document.getElementById("tip").innerHTML = "<a href='" + cookie + "'>跳转到上次进度</a>"
        }
    } else {
        setCookie("lastPath", path)
    }

    function setCookie(cname, cvalue) {
        var d = new Date();
        d.setTime(d.getTime() + (180 * 24 * 60 * 60 * 1000));
        var expires = "expires=" + d.toGMTString();
        document.cookie = cname + "=" + cvalue + "; " + expires + ";path = /";
    }

    function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i].trim();
            if (c.indexOf(name) === 0) return c.substring(name.length, c.length);
        }
        return "";
    }

    hljs.initHighlightingOnLoad()

</script>

</html>
